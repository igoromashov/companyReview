<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –ò–ù–ù - –ê–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å–∞</title>
    <!-- pdfmake + –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã Roboto -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.72/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.72/vfs_fonts.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --accent-primary: #3b82f6;
        --accent-secondary: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --border: #e2e8f0;
        --shadow: rgba(15, 23, 42, 0.1);
        --shadow-lg: rgba(15, 23, 42, 0.15);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
          --bg-primary: #0f172a;
          --bg-secondary: #1e293b;
          --bg-tertiary: #334155;
          --text-primary: #f1f5f9;
          --text-secondary: #cbd5e1;
          --text-muted: #94a3b8;
          --accent-primary: #60a5fa;
          --accent-secondary: #a78bfa;
          --success: #34d399;
          --warning: #fbbf24;
          --error: #f87171;
          --border: #475569;
          --shadow: rgba(0, 0, 0, 0.3);
          --shadow-lg: rgba(0, 0, 0, 0.4);
        }
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        animation: slideUp 0.8s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 30px;
        background: linear-gradient(
          135deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        border-radius: 24px;
        box-shadow: 0 20px 40px var(--shadow-lg);
        color: white;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="70" cy="30" r="2.5" fill="rgba(255,255,255,0.1)"/></svg>');
        animation: float 20s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
      }

      .search-section {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px var(--shadow);
        border: 1px solid var(--border);
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 12px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
      }

      .form-group.small label {
        font-size: 0.95rem;
      }

      /* –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—Ç–∏–ª–∏ */
      .custom-select {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .custom-select select {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 2px solid var(--border);
        border-radius: 16px;
        font-size: 14px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        appearance: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .custom-select select:focus {
        outline: none;
        border-color: var(--accent-primary);
        background: var(--bg-secondary);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }

      .custom-select::after {
        content: "‚ñº";
        position: absolute;
        top: 50%;
        right: 16px;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--text-secondary);
        font-size: 12px;
      }

      .input-wrapper {
        position: relative;
      }

      .form-group input {
        width: 100%;
        padding: 18px 24px;
        border: 2px solid var(--border);
        border-radius: 16px;
        font-size: 18px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }

      .form-group.small input {
        padding: 12px 16px;
        font-size: 14px;
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--accent-primary);
        background: var(--bg-secondary);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
      }

      .calculation-params {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(139, 92, 246, 0.05)
        );
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .calculation-params h3 {
        font-size: 1.1rem;
        color: var(--text-primary);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .calculation-params p {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 5px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å 10px –¥–æ 5px */
      }

      .search-btn {
        background: linear-gradient(
          135deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        color: white;
        border: none;
        padding: 18px 40px;
        border-radius: 16px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      }

      .search-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
      }

      .search-btn:active {
        transform: translateY(-1px);
      }

      .search-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      #loading {
        display: none;
        text-align: center;
        padding: 40px;
        background: var(--bg-secondary);
        border-radius: 16px;
        margin: 20px 0;
        border: 1px solid var(--border);
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: linear-gradient(135deg, var(--error), #dc2626);
        color: white;
        padding: 20px 24px;
        border-radius: 16px;
        margin: 20px 0;
        display: none;
        text-align: center;
        font-weight: 500;
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
      }

      #results {
        display: none;
      }

      .result-card {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px var(--shadow);
        border: 1px solid var(--border);
        transition: all 0.3s ease;
      }

      .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px var(--shadow-lg);
      }

      .company-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border);
      }

      .company-name {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 10px;
      }

      .company-director {
        font-size: 1.2rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* PDF –∫–Ω–æ–ø–∫–∞ */
      .pdf-section {
        text-align: center;
        margin: 20px 0;
      }

      .pdf-btn {
        background: linear-gradient(135deg, var(--success), #059669);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 16px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .pdf-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
      }

      .pdf-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: var(--bg-tertiary);
        border-radius: 16px;
        padding: 24px;
        border-left: 4px solid var(--accent-primary);
        transition: all 0.3s ease;
      }

      .metric-card:hover {
        background: var(--bg-secondary);
        transform: translateX(5px);
      }

      .metric-card.financial {
        border-left-color: var(--success);
      }

      .metric-card.calculated {
        border-left-color: var(--accent-secondary);
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.1),
          rgba(99, 102, 241, 0.1)
        );
      }

      .metric-card.profitability {
        border-left-color: var(--warning);
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.1),
          rgba(217, 119, 6, 0.1)
        );
      }

      .metric-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .metric-value {
        font-size: 1.1rem;
        color: var(--text-primary);
        font-weight: 500;
      }

      .metric-note {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-style: italic;
        margin-top: 6px;
      }

      .growth-positive {
        color: var(--success);
        font-weight: 600;
      }

      .growth-negative {
        color: var(--error);
        font-weight: 600;
      }

      /* –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è */
      .parameters-section {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 20px 0;
        margin: 16px 0;
      }

      .parameters-grid {
        display: grid;
        gap: 12px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø—ã */
        grid-template-columns: 1fr;
      }

      /* –î–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ –¥–µ—Å–∫—Ç–æ–ø–æ–≤ */
      @media (min-width: 1024px) {
        .parameters-grid {
          grid-template-columns: 1fr 1fr 1fr; /* –í—Å–µ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
          gap: 16px;
        }

        .parameters-section {
          padding: 24px 0;
        }
      }

      /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è */
      .form-group.compact {
        margin-bottom: 8px; /* –£–º–µ–Ω—å—à–∏–ª–∏ —Å 16px */
      }

      .form-group.compact label {
        font-size: 13px;
        margin-bottom: 6px; /* –£–º–µ–Ω—å—à–∏–ª–∏ —Å 8px */
      }

      .form-group.compact input,
      .form-group.compact select {
        padding: 10px 14px; /* –£–º–µ–Ω—å—à–∏–ª–∏ padding */
        font-size: 14px;
      }

      /* –ö–∞—Å—Ç–æ–º–Ω—ã–π select */
      .custom-select {
        position: relative;
      }

      .custom-select select {
        width: 100%;
        padding: 10px 35px 10px 14px;
        border: 2px solid var(--border);
        border-radius: 12px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        appearance: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .custom-select select:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .custom-select::after {
        content: "‚ñº";
        position: absolute;
        top: 50%;
        right: 12px;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--text-secondary);
        font-size: 10px;
      }

      .section {
        margin: 30px 0;
      }

      .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .info-item {
        background: var(--bg-tertiary);
        padding: 16px 20px;
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .info-item:hover {
        background: var(--bg-secondary);
      }

      .info-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 4px;
      }

      .info-value {
        color: var(--text-primary);
        font-weight: 500;
      }

      .procurement-section {
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.1),
          rgba(99, 102, 241, 0.05)
        );
        border-radius: 16px;
        padding: 25px;
        border: 1px solid rgba(139, 92, 246, 0.2);
      }

      .customer-item {
        background: var(--bg-secondary);
        margin: 12px 0;
        padding: 16px 20px;
        border-radius: 12px;
        border-left: 3px solid var(--accent-secondary);
        transition: all 0.3s ease;
      }

      .customer-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px var(--shadow);
      }

      .customer-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
      }

      .customer-stats {
        color: var(--text-secondary);
        font-size: 0.95rem;
      }

      .summary-section {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.1),
          rgba(217, 119, 6, 0.05)
        );
        border-radius: 16px;
        padding: 25px;
        border: 1px solid rgba(245, 158, 11, 0.2);
      }

      .summary-section p {
        margin: 12px 0;
        line-height: 1.7;
        color: var(--text-secondary);
      }

      /* AI-—Å–≤–æ–¥–∫–∞ —Å—Ç–∏–ª–∏ */
      .ai-summary-section {
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.15),
          rgba(59, 130, 246, 0.1)
        );
        border-radius: 20px;
        padding: 30px;
        border: 1px solid rgba(139, 92, 246, 0.3);
        margin-top: 30px;
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
        position: relative;
        overflow: hidden;
      }

      .ai-summary-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="10" cy="10" r="1.5" fill="rgba(139,92,246,0.2)"/><circle cx="90" cy="20" r="2" fill="rgba(139,92,246,0.15)"/><circle cx="30" cy="90" r="1" fill="rgba(139,92,246,0.25)"/><circle cx="80" cy="80" r="1.8" fill="rgba(139,92,246,0.2)"/></svg>');
        animation: aiFloat 25s ease-in-out infinite;
        pointer-events: none;
      }

      @keyframes aiFloat {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        50% {
          transform: translateY(-15px) rotate(180deg);
        }
      }

      .ai-summary-section .section-title {
        background: linear-gradient(
          135deg,
          var(--accent-secondary),
          var(--accent-primary)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
        font-size: 1.4rem;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .ai-summary-content {
        position: relative;
        z-index: 1;
      }

      .ai-summary-content p {
        margin: 15px 0;
        line-height: 1.8;
        color: var(--text-primary);
        font-size: 1rem;
        text-align: justify;
      }

      .ai-summary-content p:first-child {
        margin-top: 0;
      }

      .ai-summary-content p:last-child {
        margin-bottom: 0;
      }

      .profitability-highlight {
        background: linear-gradient(135deg, var(--warning), #d97706);
        color: white;
        padding: 20px;
        border-radius: 16px;
        text-align: center;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
      }

      .profitability-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .profitability-label {
        opacity: 0.9;
        font-size: 0.95rem;
      }

      .branding {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-top: 20px;
        padding: 15px;
        background: var(--bg-tertiary);
        border-radius: 10px;
      }

      /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
      @media (max-width: 768px) {
        .container {
          padding: 0 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .search-section {
          padding: 25px;
        }

        .result-card {
          padding: 20px;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .ai-summary-section {
          padding: 20px;
        }

        .ai-summary-section .section-title {
          font-size: 1.2rem;
        }
      }

      /* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeInUp 0.6s ease-out forwards;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üè¢ –ê–Ω–∞–ª–∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –ò–ù–ù</h1>
      </div>

      <div class="search-section">
        <div class="form-group">
          <label for="inn">–ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏:</label>
          <div class="input-wrapper">
            <input
              type="text"
              id="inn"
              placeholder="–í–≤–µ–¥–∏—Ç–µ 10 –∏–ª–∏ 12-–∑–Ω–∞—á–Ω—ã–π –ò–ù–ù"
              maxlength="12"
            />
          </div>
        </div>

        <div class="parameters-section">
          <h3><span class="icon">‚öôÔ∏è</span> –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á–µ—Ç–∞</h3>

          <div class="parameters-grid">
            <!-- –ü—Ä–æ—Ñ–∏–ª—å/–ø—Ä–µ—Å–µ—Ç -->
            <div class="form-group compact">
              <label>–ü—Ä–æ—Ñ–∏–ª—å/–ø—Ä–µ—Å–µ—Ç:</label>
              <div class="custom-select">
                <select id="preset-select" onchange="applyPreset()">
                  <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å</option>
                  <option value="design_classic">
                    –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–µ–∫—Ç–Ω–æ–µ –±—é—Ä–æ
                  </option>
                  <option value="design_arch">
                    –ü—Ä–æ–µ–∫—Ç–Ω–æ–µ –±—é—Ä–æ —Å –≥–µ–Ω–ø–æ–¥—Ä—è–¥–æ–º
                  </option>
                  <option value="system_integrator">–°—Ç—Ä–æ–∏—Ç–µ–ª—å –¶–û–î</option>
                  <option value="gen_contract">–ì–µ–Ω–ø–æ–¥—Ä—è–¥—á–∏–∫</option>
                  <option value="developer">–î–µ–≤–µ–ª–æ–ø–µ—Ä</option>
                </select>
              </div>
            </div>

            <!-- –°—É–±–ø–æ–¥—Ä—è–¥ -->
            <div class="form-group compact">
              <label>–ü—Ä–æ—Ü–µ–Ω—Ç —Ä–∞–±–æ—Ç –Ω–∞ —Å—É–±–ø–æ–¥—Ä—è–¥–µ (%):</label>
              <input
                type="number"
                id="subcontract-percent"
                value="50"
                min="0"
                max="100"
                oninput="updateCalculations()"
              />
            </div>

            <!-- –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã -->
            <div class="form-group compact">
              <label>–ü—Ä–æ—Ü–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ (%):</label>
              <input
                type="number"
                id="operational-percent"
                value="15"
                min="0"
                max="100"
                oninput="updateCalculations()"
              />
            </div>
          </div>

          <div class="info-tip">
            <span class="icon">üí°</span>
            <span
              >–≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–ª–∏—è—é—Ç –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏.</span
            >
          </div>
        </div>

        <button class="search-btn" onclick="searchCompany()" id="searchButton">
          üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
        </button>
      </div>

      <div id="loading">
        <div class="spinner"></div>
        <p>–°–æ–±–∏—Ä–∞–µ–º –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
      </div>

      <div class="error" id="error-message"></div>

      <div id="results">
        <div class="result-card fade-in">
          <div id="company-content">
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
          </div>
          <div class="pdf-section">
            <button
              class="pdf-btn"
              onclick="generatePDF()"
              id="pdfButton"
              disabled
            >
              üìÑ –°–∫–∞—á–∞—Ç—å PDF-–æ—Ç—á—ë—Ç
            </button>
          </div>
        </div>
        <div class="branding">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –ò–≥–æ—Ä—å –†–æ–º–∞—à–æ–≤. –í–µ—Ä—Å–∏—è: 2.1 beta</div>
      </div>
    </div>

    <script>
      let currentCompanyData = null;

      const presets = {
        design_classic: {
          sub: [20, 30],
          op: [15, 20],
          rent: [15, 25],
          label: "–í—ã—Å–æ–∫–∞—è",
        },
        design_arch: {
          sub: [40, 70],
          op: [10, 15],
          rent: [10, 18],
          label: "–°—Ä–µ–¥–Ω—è—è",
        },
        system_integrator: {
          sub: [50, 80],
          op: [10, 15],
          rent: [5, 12],
          label: "–ù–∏–∑–∫–∞—è",
        },
        gen_contract: {
          sub: [60, 90],
          op: [5, 10],
          rent: [2, 8],
          label: "–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è",
        },
        developer: {
          sub: [0, 0],
          op: [2, 5],
          rent: [15, 30],
          label: "–í—ã—Å–æ–∫–∞—è",
        },
      };

      function applyPreset() {
        const preset = presets[document.getElementById("preset-select").value];
        if (!preset) return;
        // –ë–µ—Ä—ë–º —Å—Ä–µ–¥–Ω–∏–µ
        if (preset.sub.length) {
          document.getElementById("subcontract-percent").value = Math.round(
            (preset.sub[0] + preset.sub[1]) / 2
          );
        }
        if (preset.op.length) {
          document.getElementById("operational-percent").value = Math.round(
            (preset.op[0] + preset.op[1]) / 2
          );
        }
        if (
          currentCompanyData &&
          document.getElementById("results").style.display !== "none"
        ) {
          displayResults(currentCompanyData);
        }
      }

      async function searchCompany() {
        const inn = document.getElementById("inn").value.trim();
        if (!/^\d{10}$|^\d{12}$/.test(inn)) {
          showError("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ò–ù–ù (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)");
          return;
        }

        showLoading(true);
        hideError();
        document.getElementById("results").style.display = "none";
        document.getElementById("pdfButton").disabled = true;

        try {
          // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –±–æ–ª—å—à–µ–π –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
          const proxies = [
            "https://api.allorigins.win/get?url=",
            "https://corsproxy.io/?",
            "https://api.codetabs.com/v1/proxy?quest=",
            "https://thingproxy.freeboard.io/fetch/",
          ];

          const targetUrl = `https://www.rusprofile.ru/search?query=${inn}`;
          let html = await fetchWithRetry(proxies, targetUrl);

          if (!html || typeof html !== "string" || !html.includes("<html")) {
            throw new Error(
              "–í—Å–µ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –≤–µ—Ä–Ω—É–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
            );
          }

          // –õ–æ–≥–∏—Ä—É–µ–º —á–∞—Å—Ç–∏ HTML –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          console.log("–ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤ HTML:", html.substring(0, 500));

          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
          console.log(
            "–ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ h1:",
            doc.querySelectorAll("h1").length
          );
          console.log(
            "–ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ .company-name:",
            doc.querySelectorAll(".company-name").length
          );
          console.log(
            "–ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ #anketa:",
            doc.querySelectorAll("#anketa").length
          );

          // –ò—â–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–º–ø–∞–Ω–∏–∏
          const companyInfo =
            doc.querySelector("#anketa") || doc.querySelector(".company-info");

          if (companyInfo) {
            console.log("–ù–∞–π–¥–µ–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–º–ø–∞–Ω–∏–∏");
            const detailedData = extractDetailedCompanyData(doc);
            currentCompanyData = detailedData;
            displayResults(detailedData);
            document.getElementById("pdfButton").disabled = false;
            return;
          }

          // –ò—â–µ–º –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞ —Å –±–æ–ª–µ–µ –æ–±—â–∏–º–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º–∏
          const searchResults = [
            ".search-result__item",
            ".company-item",
            "[data-company-id]",
            ".search-item",
            ".company-preview",
          ];

          let companyBlock = null;
          for (const selector of searchResults) {
            companyBlock = doc.querySelector(selector);
            if (companyBlock) {
              console.log(`–ù–∞–π–¥–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞ –ø–æ —Å–µ–ª–µ–∫—Ç–æ—Ä—É: ${selector}`);
              break;
            }
          }

          if (!companyBlock) {
            // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∫–æ–º–ø–∞–Ω–∏—é —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
            const companyLinks = doc.querySelectorAll('a[href*="/id/"]');
            console.log("–ù–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∫–æ–º–ø–∞–Ω–∏–∏:", companyLinks.length);
            if (companyLinks.length > 0) {
              // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø–µ—Ä–≤—É—é –Ω–∞–π–¥–µ–Ω–Ω—É—é –∫–æ–º–ø–∞–Ω–∏—é
              const companyUrl =
                "https://www.rusprofile.ru" +
                companyLinks[0].getAttribute("href");
              console.log("–ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–º–ø–∞–Ω–∏–∏:", companyUrl);

              // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Å —Ä–µ—Ç—Ä–∞–µ–º
              html = await fetchWithRetry(proxies, companyUrl);

              const detailDoc = parser.parseFromString(html, "text/html");

              const detailedData = extractDetailedCompanyData(detailDoc);
              currentCompanyData = detailedData;
              displayResults(detailedData);
              document.getElementById("pdfButton").disabled = false;
              return;
            }

            throw new Error(
              "–ö–æ–º–ø–∞–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –ò–ù–ù –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ò–ù–ù."
            );
          }

          // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –±–ª–æ–∫ –∫–æ–º–ø–∞–Ω–∏–∏, –Ω–æ —ç—Ç–æ –Ω–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
          console.log("–ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞");
          const companyData = extractCompanyData(companyBlock, doc);
          currentCompanyData = companyData;
          displayResults(companyData);
          document.getElementById("pdfButton").disabled = false;
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:", error);
          showError(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${error.message}. 
      –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
      ‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º
      ‚Ä¢ –°–∞–π—Ç RusProfile –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω  
      ‚Ä¢ –ö–æ–º–ø–∞–Ω–∏—è —Å —Ç–∞–∫–∏–º –ò–ù–ù –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
      ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ò–ù–ù`);
        } finally {
          showLoading(false);
        }
      }

      // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è fetch —Å —Ä–µ—Ç—Ä–∞—è–º–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π
      async function fetchWithRetry(proxies, url, retries = 2) {
        for (let attempt = 0; attempt <= retries; attempt++) {
          for (const proxy of proxies) {
            try {
              console.log(`–ü—Ä–æ–±—É–µ–º –ø—Ä–æ–∫—Å–∏: ${proxy} (–ø–æ–ø—ã—Ç–∫–∞ ${attempt + 1})`);
              const fullUrl = proxy + encodeURIComponent(url);

              const response = await fetch(fullUrl, {
                method: "GET",
                headers: {
                  "User-Agent":
                    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
                },
                timeout: 15000,
              });

              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
              }

              const data = await response.json();
              const html = data.contents || data.body || data || data.data;

              // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω—ã–π HTML
              if (typeof html === "string" && html.includes("<html")) {
                console.log(`–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑: ${proxy}`);
                console.log(`–†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: ${html.length} —Å–∏–º–≤–æ–ª–æ–≤`);
                return html;
              } else {
                throw new Error("–û—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–π HTML");
              }
            } catch (error) {
              console.warn(`–ü—Ä–æ–∫—Å–∏ ${proxy} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:`, error);
              continue;
            }
          }
        }
        throw new Error("–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ fetch –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å");
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Å–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      async function testProxies() {
        const proxies = [
          "https://api.allorigins.win/get?url=",
          "https://corsproxy.io/?",
          "https://api.codetabs.com/v1/proxy?quest=",
        ];

        console.log("–¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–æ–≤...");

        for (const proxy of proxies) {
          try {
            const testUrl =
              proxy + encodeURIComponent("https://httpbin.org/json");
            const response = await fetch(testUrl, { timeout: 5000 });
            console.log(`‚úÖ –ü—Ä–æ–∫—Å–∏ ${proxy} - –¥–æ—Å—Ç—É–ø–µ–Ω (${response.status})`);
          } catch (error) {
            console.log(`‚ùå –ü—Ä–æ–∫—Å–∏ ${proxy} - –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:`, error.message);
          }
        }
      }

      function calculateFinancialMetrics(data) {
        const calculations = {
          revenue2023: null,
          revenue2024: null,
          fotWithContributions2023: null,
          fotWithContributions2024: null,
          subcontractCosts2024: null,
          operationalCosts2024: null,
          profitBeforeTax2024: null,
          netProfit2024: null,
          profitability: null,
        };

        if (!data.taxes) return calculations;

        const parseGrowth = (str) => {
          if (!str) return 0;
          const match = str.match(/([+-]?\d+)\s*%/);
          if (!match) return 0;
          return parseInt(match[1]) / 100;
        };

        const subcontractPercent =
          parseInt(document.getElementById("subcontract-percent").value) / 100;
        const operationalPercent =
          parseInt(document.getElementById("operational-percent").value) / 100;

        const currentRevenue = parseAmount(data.revenue);
        const revenueGrowthRate = parseGrowth(data.revenueGrowth);
        const feesAmount = parseAmount(data.taxes.fees);

        if (currentRevenue > 0 && revenueGrowthRate !== 0) {
          calculations.revenue2023 = currentRevenue / (1 + revenueGrowthRate);
        }
        calculations.revenue2024 = currentRevenue;

        if (feesAmount > 0) {
          calculations.fotWithContributions2023 = (feesAmount / 0.3) * 1.3;
        }
        if (calculations.fotWithContributions2023 && revenueGrowthRate !== 0) {
          calculations.fotWithContributions2024 =
            calculations.fotWithContributions2023 * (1 + revenueGrowthRate);
        }

        if (currentRevenue > 0) {
          calculations.subcontractCosts2024 =
            currentRevenue * subcontractPercent;
          calculations.operationalCosts2024 =
            currentRevenue * operationalPercent;
        }

        if (
          calculations.revenue2024 &&
          calculations.fotWithContributions2024 &&
          calculations.subcontractCosts2024 &&
          calculations.operationalCosts2024
        ) {
          calculations.profitBeforeTax2024 =
            calculations.revenue2024 -
            calculations.fotWithContributions2024 -
            calculations.subcontractCosts2024 -
            calculations.operationalCosts2024;
        }

        if (calculations.profitBeforeTax2024 > 0) {
          calculations.netProfit2024 = calculations.profitBeforeTax2024 * 0.8;
        }

        if (calculations.netProfit2024 && calculations.revenue2024 > 0) {
          calculations.profitability =
            (calculations.netProfit2024 / calculations.revenue2024) * 100;
        }

        return calculations;
      }

      function getDefaultLogo() {
        const canvas = document.createElement("canvas");
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext("2d");

        ctx.fillStyle = "#3b82f6";
        ctx.fillRect(0, 0, 100, 100);

        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 24px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("–ò–†", 50, 50);

        return canvas.toDataURL("image/png");
      }

      async function loadLogo() {
        try {
          const response = await fetch("logo.svg");
          if (response.ok) {
            const svgText = await response.text();
            return (
              "data:image/svg+xml;base64," +
              btoa(unescape(encodeURIComponent(svgText)))
            );
          }
        } catch (error) {
          console.warn("–õ–æ–≥–æ—Ç–∏–ø logo.svg –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π");
        }

        return getDefaultLogo();
      }

      function compareProfitability(pct, presetKey) {
        if (
          !presetKey ||
          !presets[presetKey] ||
          !presets[presetKey].rent.length
        )
          return "";
        const [min, max] = presets[presetKey].rent;
        if (pct == null) return "";
        let label = "";
        if (pct < min) label = "üö® –ù–∏–∂–µ –Ω–æ—Ä–º—ã –¥–ª—è –æ—Ç—Ä–∞—Å–ª–∏";
        else if (pct > max) label = "üü¢ –í—ã—à–µ –Ω–æ—Ä–º—ã –¥–ª—è –æ—Ç—Ä–∞—Å–ª–∏";
        else
          label = `‚úÖ ${presets[presetKey].label} –¥–ª—è –æ—Ç—Ä–∞—Å–ª–∏ (${min}‚Äì${max}%)`;
        return `<div class="metric-note">${label}</div>`;
      }

      async function generatePDF() {
        if (!currentCompanyData) {
          showError("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞");
          return;
        }

        const btn = document.getElementById("pdfButton");
        btn.disabled = true;
        btn.innerHTML = "üìÑ –°–æ–∑–¥–∞—ë–º PDF‚Ä¶";

        try {
          if (typeof pdfMake === "undefined") {
            throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ pdfMake –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
          }

          const calc = calculateFinancialMetrics(currentCompanyData);

          // –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Ñ–∞–π–ª–∞
          const cleanName = currentCompanyData.name
            ? currentCompanyData.name
                .replace(/[^\u0400-\u04FF\w\s]/g, "") // –¢–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞, –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã
                .trim()
                .substring(0, 30) // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
            : "–ö–æ–º–ø–∞–Ω–∏—è";

          const content = [
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            {
              text: "–ë–ò–ó–ù–ï–°-–ê–ù–ê–õ–ò–¢–ò–ö–ê –ö–û–ú–ü–ê–ù–ò–ò",
              style: "header",
              alignment: "center",
              margin: [0, 0, 0, 20],
            },

            // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
            {
              text: currentCompanyData.name || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è",
              style: "title",
              margin: [0, 0, 0, 10],
            },

            // –î–∏—Ä–µ–∫—Ç–æ—Ä
            {
              text: `–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä: ${
                currentCompanyData.director || "–ù–µ –Ω–∞–π–¥–µ–Ω–æ"
              }`,
              style: "subtitle",
              margin: [0, 0, 0, 20],
            },

            // –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å (–±–æ–ª—å—à–æ–π –±–ª–æ–∫)
            ...(calc.profitability
              ? [
                  {
                    table: {
                      widths: ["*"],
                      body: [
                        [
                          {
                            text: `–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞: ${calc.profitability.toFixed(
                              2
                            )}%`,
                            style: "profitability",
                            alignment: "center",
                            fillColor: "#F59E0B",
                            color: "white",
                          },
                        ],
                      ],
                    },
                    layout: "noBorders",
                    margin: [0, 0, 0, 20],
                  },
                ]
              : []),
          ];

          // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          content.push({
            text: "–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏",
            style: "subheader",
            margin: [0, 0, 0, 10],
          });

          const mainMetrics = [];
          if (currentCompanyData.revenue !== "–ù–µ –Ω–∞–π–¥–µ–Ω–æ") {
            mainMetrics.push([
              "–í—ã—Ä—É—á–∫–∞ 2024",
              `${currentCompanyData.revenue}${
                currentCompanyData.revenueGrowth
                  ? " (" + currentCompanyData.revenueGrowth + ")"
                  : ""
              }`,
            ]);
          }
          if (calc.netProfit2024) {
            mainMetrics.push([
              "–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å 2024",
              formatAmountForPDF(calc.netProfit2024),
            ]);
          }
          if (calc.fotWithContributions2024) {
            mainMetrics.push([
              "–§–û–¢ + –≤–∑–Ω–æ—Å—ã 2024",
              formatAmountForPDF(calc.fotWithContributions2024),
            ]);
          }
          if (currentCompanyData.profitGrowth) {
            mainMetrics.push(["–†–æ—Å—Ç –ø—Ä–∏–±—ã–ª–∏", currentCompanyData.profitGrowth]);
          }
          if (currentCompanyData.valueGrowth) {
            mainMetrics.push([
              "–†–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏",
              currentCompanyData.valueGrowth,
            ]);
          }

          if (mainMetrics.length > 0) {
            content.push({
              table: {
                widths: ["60%", "40%"],
                headerRows: 1,
                body: [
                  [
                    { text: "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å", style: "tableHeader" },
                    { text: "–ó–Ω–∞—á–µ–Ω–∏–µ", style: "tableHeader" },
                  ],
                  ...mainMetrics,
                ],
              },
              layout: "lightHorizontalLines",
              margin: [0, 0, 0, 20],
            });
          }

          // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã
          content.push({
            text: "–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏",
            style: "subheader",
            margin: [0, 0, 0, 10],
          });

          const calcMetrics = [
            [
              { text: "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å", style: "tableHeader" },
              { text: "–ó–Ω–∞—á–µ–Ω–∏–µ", style: "tableHeader" },
            ],
          ];

          if (calc.revenue2024) {
            calcMetrics.push([
              "–í—ã—Ä—É—á–∫–∞ 2024",
              formatAmountForPDF(calc.revenue2024),
            ]);
          }
          if (calc.fotWithContributions2024) {
            calcMetrics.push([
              "–§–û–¢ + –≤–∑–Ω–æ—Å—ã 2024",
              formatAmountForPDF(calc.fotWithContributions2024),
            ]);
          }
          if (calc.subcontractCosts2024) {
            calcMetrics.push([
              `–°—É–±–ø–æ–¥—Ä—è–¥–Ω—ã–µ —Ä–∞–±–æ—Ç—ã (${
                document.getElementById("subcontract-percent").value
              }%)`,
              formatAmountForPDF(calc.subcontractCosts2024),
            ]);
          }
          if (calc.operationalCosts2024) {
            calcMetrics.push([
              `–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (${
                document.getElementById("operational-percent").value
              }%)`,
              formatAmountForPDF(calc.operationalCosts2024),
            ]);
          }
          if (calc.profitBeforeTax2024) {
            calcMetrics.push([
              "–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–∞",
              formatAmountForPDF(calc.profitBeforeTax2024),
            ]);
          }
          if (calc.netProfit2024) {
            calcMetrics.push([
              "–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å (-20% –Ω–∞–ª–æ–≥)",
              formatAmountForPDF(calc.netProfit2024),
            ]);
          }

          content.push({
            table: {
              widths: ["60%", "40%"],
              body: calcMetrics,
            },
            layout: "lightHorizontalLines",
            margin: [0, 0, 0, 20],
          });

          // –†–µ–∫–≤–∏–∑–∏—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏
          content.push({
            text: "–†–µ–∫–≤–∏–∑–∏—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏",
            style: "subheader",
            margin: [0, 0, 0, 10],
          });

          content.push({
            columns: [
              [
                { text: "–ò–ù–ù:", bold: true },
                {
                  text: currentCompanyData.inn || "–ù–µ –Ω–∞–π–¥–µ–Ω–æ",
                  margin: [0, 0, 0, 5],
                },
                { text: "–û–ì–†–ù:", bold: true },
                {
                  text: currentCompanyData.ogrn || "–ù–µ –Ω–∞–π–¥–µ–Ω–æ",
                  margin: [0, 0, 0, 10],
                },
              ],
              [
                { text: "–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", bold: true },
                {
                  text: currentCompanyData.registrationDate || "–ù–µ –Ω–∞–π–¥–µ–Ω–æ",
                  margin: [0, 0, 0, 5],
                },
                { text: "–£—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª:", bold: true },
                { text: currentCompanyData.capital || "–ù–µ –Ω–∞–π–¥–µ–Ω–æ" },
              ],
            ],
            margin: [0, 0, 0, 15],
          });

          // –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å
          if (
            currentCompanyData.address &&
            currentCompanyData.address !== "–ù–µ –Ω–∞–π–¥–µ–Ω–æ"
          ) {
            content.push({
              text: "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å:",
              bold: true,
              margin: [0, 0, 0, 5],
            });
            content.push({
              text: currentCompanyData.address,
              margin: [0, 0, 0, 15],
            });
          }

          // –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          if (currentCompanyData.taxes) {
            content.push({
              text: `–ò—Å—Ö–æ–¥–Ω—ã–µ –Ω–∞–ª–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (${currentCompanyData.taxes.year})`,
              style: "subheader",
              margin: [0, 0, 0, 10],
            });

            const taxData = [];
            if (currentCompanyData.taxes.taxes) {
              taxData.push(["–ù–∞–ª–æ–≥–∏", currentCompanyData.taxes.taxes]);
            }
            if (currentCompanyData.taxes.fees) {
              taxData.push(["–í–∑–Ω–æ—Å—ã", currentCompanyData.taxes.fees]);
            }

            if (taxData.length > 0) {
              content.push({
                table: {
                  widths: ["50%", "50%"],
                  body: [
                    [
                      { text: "–¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞", style: "tableHeader" },
                      { text: "–°—É–º–º–∞", style: "tableHeader" },
                    ],
                    ...taxData,
                  ],
                },
                layout: "lightHorizontalLines",
                margin: [0, 0, 0, 15],
              });
            }
          }

          // –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏
          if (
            currentCompanyData.procurement &&
            currentCompanyData.procurement.customers.length > 0
          ) {
            content.push({
              text: "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏",
              style: "subheader",
              margin: [0, 0, 0, 10],
            });

            content.push({
              text: `–í —Ä–æ–ª–∏: ${currentCompanyData.procurement.role}`,
              bold: true,
              margin: [0, 0, 0, 10],
            });

            const procurementData = [
              [
                { text: "–ó–∞–∫–∞–∑—á–∏–∫", style: "tableHeader" },
                { text: "–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∏ —Å—É–º–º–∞", style: "tableHeader" },
              ],
            ];

            currentCompanyData.procurement.customers
              .slice(0, 5)
              .forEach((customer) => {
                procurementData.push([
                  customer.name,
                  `${customer.contracts} –Ω–∞ ${customer.amount}`,
                ]);
              });

            content.push({
              table: {
                widths: ["60%", "40%"],
                body: procurementData,
              },
              layout: "lightHorizontalLines",
              margin: [0, 0, 0, 10],
            });

            if (currentCompanyData.procurement.totalContracts > 0) {
              content.push({
                text: `–í—Å–µ–≥–æ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ ${currentCompanyData.procurement.totalContracts} –∑–∞–∫—É–ø–∫–∞—Ö –Ω–∞ —Å—É–º–º—É ${currentCompanyData.procurement.totalAmount}`,
                alignment: "center",
                bold: true,
                margin: [0, 10, 0, 15],
              });
            }
          }

          // –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞
          if (currentCompanyData.summary) {
            content.push({
              text: "–°–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
              style: "subheader",
              margin: [0, 0, 0, 10],
            });

            const summaryParagraphs = currentCompanyData.summary.split("\n\n");
            summaryParagraphs.forEach((paragraph) => {
              if (paragraph.trim()) {
                content.push({
                  text: paragraph.trim(),
                  margin: [0, 0, 0, 8],
                });
              }
            });
          }

          // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: AI-—Å–≤–æ–¥–∫–∞ –≤ PDF –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

          const docDefinition = {
            content: content,

            styles: {
              header: {
                fontSize: 16,
                bold: true,
                color: "#3b82f6",
              },
              title: {
                fontSize: 14,
                bold: true,
              },
              subtitle: {
                fontSize: 12,
                color: "#666666",
              },
              subheader: {
                fontSize: 12,
                bold: true,
                margin: [0, 15, 0, 5],
              },
              profitability: {
                fontSize: 16,
                bold: true,
                margin: [0, 10],
              },
              tableHeader: {
                bold: true,
                fillColor: "#3b82f6",
                color: "white",
              },
            },

            defaultStyle: {
              fontSize: 10,
            },

            footer: {
              columns: [
                {
                  text: "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –ò–≥–æ—Ä—å –†–æ–º–∞—à–æ–≤ ¬∑ –í–µ—Ä—Å–∏—è 2.2 beta",
                  fontSize: 8,
                  color: "#666666",
                },
                {
                  text: new Date().toLocaleDateString("ru-RU"),
                  alignment: "right",
                  fontSize: 8,
                  color: "#666666",
                },
              ],
              margin: [40, 10],
            },
          };

          // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
          const fileName = `–ê–Ω–∞–ª–∏–∑_${cleanName}_${new Date()
            .toLocaleDateString("ru-RU")
            .replace(/\./g, "-")}.pdf`;

          pdfMake.createPdf(docDefinition).download(fileName);
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ PDF:", error);
          showError(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF: ${error.message}`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = "üìÑ –°–∫–∞—á–∞—Ç—å PDF-–æ—Ç—á—ë—Ç";
        }
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è PDF
      function formatAmountForPDF(amount) {
        if (!amount || amount === 0) return "0 —Ä—É–±.";

        if (amount >= 1000000000) {
          return `${(amount / 1000000000).toFixed(1)} –º–ª—Ä–¥ —Ä—É–±.`;
        } else if (amount >= 1000000) {
          return `${(amount / 1000000).toFixed(1)} –º–ª–Ω —Ä—É–±.`;
        } else if (amount >= 1000) {
          return `${(amount / 1000).toFixed(1)} —Ç—ã—Å —Ä—É–±.`;
        } else {
          return `${Math.round(amount)} —Ä—É–±.`;
        }
      }

      // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É–º–º –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –¥–ª—è PDF
      function formatAmountRussian(amount) {
        if (!amount || amount === 0) return "0";

        if (amount >= 1000000000) {
          return `${(amount / 1000000000).toFixed(1)} –º–ª—Ä–¥ —Ä—É–±.`;
        } else if (amount >= 1000000) {
          return `${(amount / 1000000).toFixed(1)} –º–ª–Ω —Ä—É–±.`;
        } else if (amount >= 1000) {
          return `${(amount / 1000).toFixed(1)} —Ç—ã—Å —Ä—É–±.`;
        } else {
          return `${amount.toFixed(0)} —Ä—É–±.`;
        }
      }

      // –§—É–Ω–∫—Ü–∏—è —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ —Å–ª—É—á–∞—è
      function transliterate(text) {
        const map = {
          –∞: "a",
          –±: "b",
          –≤: "v",
          –≥: "g",
          –¥: "d",
          –µ: "e",
          —ë: "yo",
          –∂: "zh",
          –∑: "z",
          –∏: "i",
          –π: "j",
          –∫: "k",
          –ª: "l",
          –º: "m",
          –Ω: "n",
          –æ: "o",
          –ø: "p",
          —Ä: "r",
          —Å: "s",
          —Ç: "t",
          —É: "u",
          —Ñ: "f",
          —Ö: "h",
          —Ü: "c",
          —á: "ch",
          —à: "sh",
          —â: "sch",
          —ä: "",
          —ã: "y",
          —å: "",
          —ç: "e",
          —é: "yu",
          —è: "ya",
          –ê: "A",
          –ë: "B",
          –í: "V",
          –ì: "G",
          –î: "D",
          –ï: "E",
          –Å: "Yo",
          –ñ: "Zh",
          –ó: "Z",
          –ò: "I",
          –ô: "J",
          –ö: "K",
          –õ: "L",
          –ú: "M",
          –ù: "N",
          –û: "O",
          –ü: "P",
          –†: "R",
          –°: "S",
          –¢: "T",
          –£: "U",
          –§: "F",
          –•: "H",
          –¶: "C",
          –ß: "Ch",
          –®: "Sh",
          –©: "Sch",
          –™: "",
          –´: "Y",
          –¨: "",
          –≠: "E",
          –Æ: "Yu",
          –Ø: "Ya",
        };

        return text
          .split("")
          .map((char) => map[char] || char)
          .join("");
      }

      function extractDetailedCompanyData(doc) {
        let name = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
        let director = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
        let revenue = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
        let revenueGrowth = "";
        let profitGrowth = "";
        let valueGrowth = "";
        let ogrn = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
        let innFound = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
        let address = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
        let registrationDate = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
        let capital = "–ù–µ –Ω–∞–π–¥–µ–Ω–æ";
        let summary = "";
        let procurement = null;
        let taxes = null;
        let aiSummary = ""; // –î–æ–±–∞–≤–ª—è–µ–º AI-—Å–≤–æ–¥–∫—É

        // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (—É–ª—É—á—à–µ–Ω–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä)
        const titleElement =
          doc.querySelector("h1[itemprop='name']") ||
          doc.querySelector(".company-name") ||
          doc.querySelector("h1");
        if (titleElement) {
          name = titleElement.textContent.trim();
        }

        if (name === "–ù–µ –Ω–∞–π–¥–µ–Ω–æ") {
          const descriptionText =
            doc.querySelector(".information-text")?.textContent || "";
          const nameMatch = descriptionText.match(
            /–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä ([^-]+) -/
          );
          if (nameMatch) {
            name = nameMatch[1].trim();
          }
        }

        // –î–∏—Ä–µ–∫—Ç–æ—Ä (—É–ª—É—á—à–µ–Ω–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä)
        const managerBlock =
          doc.querySelector("[itemprop='founder']") ||
          doc.querySelector(".company-info__item");
        if (managerBlock) {
          const chiefTitle =
            managerBlock.querySelector(".chief-title") ||
            managerBlock.querySelector("[itemprop='jobTitle']");
          const managerLink =
            managerBlock.querySelector("a[itemprop='name']") ||
            managerBlock.querySelector("a");

          if (
            chiefTitle &&
            chiefTitle.textContent.includes("–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä") &&
            managerLink
          ) {
            const managerName = managerLink.textContent
              .trim()
              .replace(/–ø–æ–¥—Ä–æ–±–Ω–µ–µ.*/, "")
              .trim();
            if (managerName) {
              director = managerName;
            }
          }
        }

        if (director === "–ù–µ –Ω–∞–π–¥–µ–Ω–æ") {
          const descriptionText =
            doc.querySelector(".information-text")?.textContent || "";
          const directorMatch = descriptionText.match(
            /–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä [^-]+ - ([^(]+)/
          );
          if (directorMatch) {
            director = directorMatch[1].trim();
          }
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (—É–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã)
        const ogrnElement =
          doc.querySelector("#clip_ogrn") ||
          doc.querySelector("[itemprop='ogrn']");
        if (ogrnElement) ogrn = ogrnElement.textContent.trim();

        const innElement =
          doc.querySelector("#clip_inn") ||
          doc.querySelector("[itemprop='taxID']");
        if (innElement) innFound = innElement.textContent.trim();

        const addressElement =
          doc.querySelector("#clip_address") ||
          doc.querySelector("[itemprop='address']");
        if (addressElement)
          address = addressElement.textContent.trim().replace(/\s+/g, " ");

        const regDateElement =
          doc.querySelector('[itemprop="foundingDate"]') ||
          doc.querySelector(".reg-date");
        if (regDateElement)
          registrationDate = regDateElement.textContent.trim();

        // –£—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
        const allElements = doc.querySelectorAll(".company-info__text");
        for (const element of allElements) {
          if (
            element.textContent.includes("—Ä—É–±.") &&
            element.textContent.match(/\d+.*—Ä—É–±\./)
          ) {
            capital = element.textContent.trim();
            break;
          }
        }

        // –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞
        const summaryBlock =
          doc.querySelector(".enquiry-tile") ||
          doc.querySelector(".company-summary");
        if (summaryBlock) {
          const summaryTexts = summaryBlock.querySelectorAll(
            ".enquiry-tile__text"
          );
          const summaryParts = [];
          summaryTexts.forEach((textElement) => {
            const text = textElement.textContent.trim();
            if (text) {
              summaryParts.push(text);
            }
          });
          summary = summaryParts.join("\n\n");
        }

        // AI-—Å–≤–æ–¥–∫–∞ (–Ω–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥)
        const aiSummaryBlock = doc.querySelector(
          ".company-description__wrapper"
        );
        if (aiSummaryBlock) {
          const aiTextElement = aiSummaryBlock.querySelector(
            ".company-description__text"
          );
          if (aiTextElement) {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤
            const paragraphs = aiTextElement.querySelectorAll("p");
            const aiParts = [];
            paragraphs.forEach((paragraph) => {
              const text = paragraph.textContent.trim();
              if (text) {
                aiParts.push(text);
              }
            });
            aiSummary = aiParts.join("\n\n");

            console.log(
              "–ù–∞–π–¥–µ–Ω–∞ AI-—Å–≤–æ–¥–∫–∞:",
              aiSummary.substring(0, 200) + "..."
            );
          }
        }

        // –ù–ê–õ–û–ì–ò –ò –°–ë–û–†–´ (—É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥)
        const taxesBlock =
          doc.querySelector(".taxes-tile") ||
          doc.querySelector("[data-tile='taxes']");
        if (taxesBlock) {
          taxes = {
            year: "",
            taxes: "",
            fees: "",
          };

          const yearText = taxesBlock.textContent;
          const yearMatch = yearText.match(/–∑–∞ (\d{4}) –≥–æ–¥/);
          if (yearMatch) {
            taxes.year = yearMatch[1];
          }

          const allCols = taxesBlock.querySelectorAll(".connexion-col");

          allCols.forEach((col) => {
            const titleElement = col.querySelector(".connexion-col__title");
            const numElement = col.querySelector(".num");

            if (titleElement && numElement) {
              const title = titleElement.textContent.trim();
              const numValue = numElement.textContent.trim();
              const fullNumText =
                col.querySelector(".connexion-col__num")?.textContent.trim() ||
                "";

              if (title.includes("–ù–∞–ª–æ–≥–∏")) {
                const unitMatch = fullNumText.match(/–º–ª–Ω|—Ç—ã—Å|—Ä—É–±/);
                const unit = unitMatch ? unitMatch[0] : "—Ä—É–±";
                taxes.taxes = `${numValue} ${
                  unit === "–º–ª–Ω"
                    ? "–º–ª–Ω —Ä—É–±."
                    : unit === "—Ç—ã—Å"
                    ? "—Ç—ã—Å —Ä—É–±."
                    : "—Ä—É–±."
                }`;
              } else if (title.includes("–í–∑–Ω–æ—Å—ã")) {
                const unitMatch = fullNumText.match(/–º–ª–Ω|—Ç—ã—Å|—Ä—É–±/);
                const unit = unitMatch ? unitMatch[0] : "—Ä—É–±";
                taxes.fees = `${numValue} ${
                  unit === "–º–ª–Ω"
                    ? "–º–ª–Ω —Ä—É–±."
                    : unit === "—Ç—ã—Å"
                    ? "—Ç—ã—Å —Ä—É–±."
                    : "—Ä—É–±."
                }`;
              }
            }
          });
        }

        // –ì–û–°–ó–ê–ö–£–ü–ö–ò (—É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥)
        const procurementBlock =
          doc.querySelector(".gz-tile") ||
          doc.querySelector("[data-tile='procurement']");
        if (procurementBlock) {
          procurement = {
            role: "",
            customers: [],
            totalContracts: 0,
            totalAmount: "",
          };

          const roleElement =
            procurementBlock.querySelector(".tab-opener.active") ||
            procurementBlock.querySelector(".role-tab");
          if (roleElement) {
            procurement.role = roleElement.textContent.trim();
          }

          const customerItems =
            procurementBlock.querySelectorAll(".founder-item") ||
            procurementBlock.querySelectorAll(".customer-block");
          customerItems.forEach((item) => {
            const nameElement =
              item.querySelector(".founder-item__title span") ||
              item.querySelector(".customer-name");
            const statsElement =
              item.querySelector(".founder-item__dl") ||
              item.querySelector(".customer-stats");

            if (nameElement && statsElement) {
              const name = nameElement.textContent.trim();
              const dtElement = statsElement.querySelector("dt");
              const ddElement = statsElement.querySelector("dd");

              if (dtElement && ddElement) {
                const contractsText = dtElement.textContent.trim();
                const amount = ddElement.textContent.trim();

                procurement.customers.push({
                  name: name,
                  contracts: contractsText,
                  amount: amount,
                });
              }
            }
          });

          const totalStatsText = procurementBlock.textContent;
          const totalMatch = totalStatsText.match(
            /—É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∞.*?–≤ (\d+).*?–∑–∞–∫—É–ø–∫–∞—Ö.*?–Ω–∞ —Å—É–º–º—É.*?([\d\s]+—Ä—É–±\.)/
          );
          if (totalMatch) {
            procurement.totalContracts = parseInt(totalMatch[1]);
            procurement.totalAmount = totalMatch[2].trim();
          }
        }

        // –§–ò–ù–ê–ù–°–û–í–´–ï –î–ê–ù–ù–´–ï (—É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥)
        const financeBlock =
          doc.querySelector(".tile-finance-columns") ||
          doc.querySelector("[data-tile='finance']");
        if (financeBlock) {
          const revenueCol =
            financeBlock
              .querySelector('[data-tab_name="tab_revenue"]')
              ?.closest(".finance-col") ||
            financeBlock.querySelector(".revenue-col");
          if (revenueCol) {
            const numElement = revenueCol.querySelector(".num");
            const numTextElement = revenueCol.querySelector(".num-text");
            const diffElement = revenueCol.querySelector(".diff.mt");

            if (numElement && numTextElement) {
              const number = numElement.textContent.trim();
              const unit = numTextElement.textContent
                .trim()
                .replace(/&nbsp;/g, " ");
              revenue = `${number} ${unit}`;

              if (diffElement) {
                revenueGrowth = diffElement.textContent
                  .trim()
                  .replace(/\s+/g, " ");
              }
            }
          }

          const profitCol =
            financeBlock
              .querySelector('[data-tab_name="tab_profit"]')
              ?.closest(".finance-col") ||
            financeBlock.querySelector(".profit-col");
          if (profitCol) {
            const diffElement = profitCol.querySelector(".diff.mt");
            if (diffElement) {
              profitGrowth = diffElement.textContent
                .trim()
                .replace(/\s+/g, " ");
            }
          }

          const valueCol =
            financeBlock
              .querySelector('[data-tab_name="tab_value"]')
              ?.closest(".finance-col") ||
            financeBlock.querySelector(".value-col");
          if (valueCol) {
            const diffElement = valueCol.querySelector(".diff.mt");
            if (diffElement) {
              valueGrowth = diffElement.textContent.trim().replace(/\s+/g, " ");
            }
          }
        }

        return {
          name,
          director,
          revenue,
          revenueGrowth,
          profitGrowth,
          valueGrowth,
          ogrn,
          inn: innFound,
          address,
          registrationDate,
          capital,
          summary,
          procurement,
          taxes,
          aiSummary, // –î–æ–±–∞–≤–ª—è–µ–º AI-—Å–≤–æ–¥–∫—É –∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–º –¥–∞–Ω–Ω—ã–º
          isDetailed: true,
        };
      }

      function extractCompanyData(companyBlock, doc) {
        return {
          name: "–ù–∞–π–¥–µ–Ω–∞ –∫–æ–º–ø–∞–Ω–∏—è",
          director: "–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...",
          revenue: "–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...",
          isDetailed: false,
        };
      }

      function parseAmount(str) {
        if (!str) return 0;

        const numMatch = str.match(/([\d,\.]+)/);
        if (!numMatch) return 0;

        let number = parseFloat(numMatch[1].replace(",", "."));
        const lowerStr = str.toLowerCase();

        if (lowerStr.includes("–º–ª—Ä–¥")) {
          number = number * 1000000000;
        } else if (lowerStr.includes("–º–ª–Ω")) {
          number = number * 1000000;
        } else if (lowerStr.includes("—Ç—ã—Å")) {
          number = number * 1000;
        }

        return number;
      }

      function formatAmount(amount) {
        if (!amount || amount === 0) return null;

        if (amount >= 1000000000) {
          return `${(amount / 1000000000).toFixed(1)} –º–ª—Ä–¥ —Ä—É–±.`;
        } else if (amount >= 1000000) {
          return `${(amount / 1000000).toFixed(1)} –º–ª–Ω —Ä—É–±.`;
        } else if (amount >= 1000) {
          return `${(amount / 1000).toFixed(1)} —Ç—ã—Å —Ä—É–±.`;
        } else {
          return `${amount.toFixed(0)} —Ä—É–±.`;
        }
      }

      function formatGrowth(growthText, hasValue = false) {
        if (!growthText) return "";

        const isPositive = growthText.includes("‚Üë") || growthText.includes("+");
        const isNegative = growthText.includes("‚Üì") || growthText.includes("-");

        let className = "";
        if (isPositive) className = "growth-positive";
        if (isNegative) className = "growth-negative";

        if (hasValue) {
          return `<span class="${className}">(${growthText})</span>`;
        } else {
          return `<span class="${className}">${growthText}</span>`;
        }
      }

      function displayResults(data) {
        if (!data.isDetailed) {
          document.getElementById("company-content").innerHTML = `
                    <div class="company-header">
                        <div class="company-name">${data.name}</div>
                        <div class="company-director">${data.director}</div>
                    </div>
                `;
          document.getElementById("results").style.display = "block";
          return;
        }

        const calculations = calculateFinancialMetrics(data);

        let contentHtml = `
                <div class="company-header">
                    <div class="company-name">${data.name}</div>
                    <div class="company-director">–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä: ${data.director}</div>
                </div>
            `;

        // –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å - –≤—ã–¥–µ–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
        if (calculations.profitability) {
          contentHtml += `
                    <div class="profitability-highlight">
                        <div class="profitability-value">${calculations.profitability.toFixed(
                          2
                        )}%</div>
                        <div class="profitability-label">–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞</div>
                    </div>
                `;
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        contentHtml += `<div class="metrics-grid">`;

        // –í—ã—Ä—É—á–∫–∞
        if (data.revenue !== "–ù–µ –Ω–∞–π–¥–µ–Ω–æ") {
          contentHtml += `
                    <div class="metric-card financial">
                        <div class="metric-label">üìà –í—ã—Ä—É—á–∫–∞ 2024</div>
                        <div class="metric-value">${data.revenue} ${
            data.revenueGrowth ? formatGrowth(data.revenueGrowth, true) : ""
          }</div>
                    </div>
                `;
        }

        // –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å
        if (calculations.netProfit2024) {
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">üí∞ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å 2024</div>
                        <div class="metric-value">${formatAmount(
                          calculations.netProfit2024
                        )}</div>
                        <div class="metric-note">–†–∞—Å—á—ë—Ç –ø–æ –Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏</div>
                    </div>
                `;
        }

        // –§–û–¢ + –í–∑–Ω–æ—Å—ã
        if (calculations.fotWithContributions2024) {
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">üë• –§–û–¢ + –í–∑–Ω–æ—Å—ã 2024</div>
                        <div class="metric-value">${formatAmount(
                          calculations.fotWithContributions2024
                        )}</div>
                        <div class="metric-note">–¢–æ—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç –∏–∑ –≤–∑–Ω–æ—Å–æ–≤</div>
                    </div>
                `;
        }

        // –†–∞—Å—Ö–æ–¥—ã –Ω–∞ —Å—É–±–ø–æ–¥—Ä—è–¥
        if (calculations.subcontractCosts2024) {
          const subcontractPercent = document.getElementById(
            "subcontract-percent"
          ).value;
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">üî® –°—É–±–ø–æ–¥—Ä—è–¥–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</div>
                        <div class="metric-value">${formatAmount(
                          calculations.subcontractCosts2024
                        )}</div>
                        <div class="metric-note">${subcontractPercent}% –æ—Ç –≤—ã—Ä—É—á–∫–∏</div>
                    </div>
                `;
        }

        // –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
        if (calculations.operationalCosts2024) {
          const operationalPercent = document.getElementById(
            "operational-percent"
          ).value;
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">‚öôÔ∏è –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
                        <div class="metric-value">${formatAmount(
                          calculations.operationalCosts2024
                        )}</div>
                        <div class="metric-note">${operationalPercent}% –æ—Ç –≤—ã—Ä—É—á–∫–∏</div>
                    </div>
                `;
        }

        // –ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤
        if (calculations.profitBeforeTax2024) {
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">üìä –ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–æ–≤</div>
                        <div class="metric-value">${formatAmount(
                          calculations.profitBeforeTax2024
                        )}</div>
                        <div class="metric-note">–î–æ —É–ø–ª–∞—Ç—ã 20% –Ω–∞–ª–æ–≥–∞</div>
                    </div>
                `;
        }

        contentHtml += `</div>`;

        // –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        contentHtml += `
                <div class="section">
                    <div class="section-title">üìã –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</div>
                    <div class="metrics-grid">
            `;

        if (data.taxes) {
          contentHtml += `
                    <div class="metric-card">
                        <div class="metric-label">üèõÔ∏è –í–∑–Ω–æ—Å—ã (${data.taxes.year})</div>
                        <div class="metric-value">${data.taxes.fees}</div>
                        <div class="metric-note">–û—Å–Ω–æ–≤–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –§–û–¢</div>
                    </div>
                `;
        }

        if (data.profitGrowth) {
          contentHtml += `
                    <div class="metric-card">
                        <div class="metric-label">üìà –†–æ—Å—Ç –ø—Ä–∏–±—ã–ª–∏</div>
                        <div class="metric-value">${formatGrowth(
                          data.profitGrowth,
                          false
                        )}</div>
                        <div class="metric-note">–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞–∑–≤–∏—Ç–∏—è</div>
                    </div>
                `;
        }

        if (data.valueGrowth) {
          contentHtml += `
                    <div class="metric-card">
                        <div class="metric-label">üè¢ –†–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</div>
                        <div class="metric-value">${formatGrowth(
                          data.valueGrowth,
                          false
                        )}</div>
                        <div class="metric-note">–î–∏–Ω–∞–º–∏–∫–∞ –æ—Ü–µ–Ω–∫–∏</div>
                    </div>
                `;
        }

        contentHtml += `</div></div>`;

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        contentHtml += `
                <div class="section">
                    <div class="section-title">üìã –†–µ–∫–≤–∏–∑–∏—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">–ò–ù–ù</div>
                            <div class="info-value">${data.inn}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–û–ì–†–ù</div>
                            <div class="info-value">${data.ogrn}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                            <div class="info-value">${data.registrationDate}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">–£—Å—Ç–∞–≤–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª</div>
                            <div class="info-value">${data.capital}</div>
                        </div>
                        <div class="info-item" style="grid-column: 1/-1;">
                            <div class="info-label">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å</div>
                            <div class="info-value">${data.address}</div>
                        </div>
                    </div>
                </div>
            `;

        // –ì–æ—Å–∑–∞–∫—É–ø–∫–∏
        if (data.procurement && data.procurement.customers.length > 0) {
          contentHtml += `
                    <div class="section">
                        <div class="section-title">üèõÔ∏è –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–∫—É–ø–∫–∏</div>
                        <div class="procurement-section">
                            <p style="margin-bottom: 15px;"><strong>–í —Ä–æ–ª–∏:</strong> ${data.procurement.role}</p>
                            <p style="margin-bottom: 15px;"><strong>–¢–æ–ø-${data.procurement.customers.length} –∑–∞–∫–∞–∑—á–∏–∫–æ–≤:</strong></p>
                `;

          data.procurement.customers.forEach((customer, index) => {
            contentHtml += `
                        <div class="customer-item">
                            <div class="customer-name">${index + 1}. ${
              customer.name
            }</div>
                            <div class="customer-stats">${
                              customer.contracts
                            } –Ω–∞ ${customer.amount}</div>
                        </div>
                    `;
          });

          if (data.procurement.totalContracts > 0) {
            contentHtml += `
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 12px; margin-top: 15px; text-align: center; font-weight: 600;">
                            üìä –í—Å–µ–≥–æ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∞ –≤ ${data.procurement.totalContracts} –∑–∞–∫—É–ø–∫–∞—Ö –Ω–∞ —Å—É–º–º—É ${data.procurement.totalAmount}
                        </div>
                    `;
          }

          contentHtml += `</div></div>`;
        }

        // –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞
        if (data.summary) {
          contentHtml += `
                    <div class="section">
                        <div class="section-title">üìÑ –°–ø—Ä–∞–≤–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                        <div class="summary-section">
                            ${data.summary
                              .split("\n\n")
                              .map((paragraph) => `<p>${paragraph}</p>`)
                              .join("")}
                        </div>
                    </div>
                `;
        }

        // AI-—Å–≤–æ–¥–∫–∞ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å)
        if (data.aiSummary) {
          contentHtml += `
                    <div class="ai-summary-section">
                        <div class="section-title">ü§ñ AI-–∞–Ω–∞–ª–∏–∑ –∫–æ–º–ø–∞–Ω–∏–∏</div>
                        <div class="ai-summary-content">
                            ${data.aiSummary
                              .split("\n\n")
                              .map((paragraph) => `<p>${paragraph}</p>`)
                              .join("")}
                        </div>
                    </div>
                `;
        }

        document.getElementById("company-content").innerHTML = contentHtml;
        document.getElementById("results").style.display = "block";
      }

      function showLoading(show) {
        const loading = document.getElementById("loading");
        const button = document.getElementById("searchButton");

        loading.style.display = show ? "block" : "none";
        button.disabled = show;

        if (show) {
          button.innerHTML = "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...";
        } else {
          button.innerHTML = "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é";
        }
      }

      function showError(message) {
        const error = document.getElementById("error-message");
        error.textContent = message;
        error.style.display = "block";
        error.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function hideError() {
        document.getElementById("error-message").style.display = "none";
      }

      // –ü–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      document
        .getElementById("subcontract-percent")
        .addEventListener("input", function () {
          if (
            currentCompanyData &&
            document.getElementById("results").style.display !== "none"
          ) {
            displayResults(currentCompanyData);
          }
        });

      document
        .getElementById("operational-percent")
        .addEventListener("input", function () {
          if (
            currentCompanyData &&
            document.getElementById("results").style.display !== "none"
          ) {
            displayResults(currentCompanyData);
          }
        });

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ò–ù–ù
      document.getElementById("inn").addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 12) {
          value = value.slice(0, 12);
        }
        e.target.value = value;

        if (value.length > 0) {
          hideError();
        }
      });

      // Enter –¥–ª—è –ø–æ–∏—Å–∫–∞
      document.getElementById("inn").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          searchCompany();
        }
      });

      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.addEventListener("load", function () {
        document.getElementById("inn").focus();
      });
    </script>
  </body>
</html>
