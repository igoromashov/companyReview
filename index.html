<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Парсинг компаний по ИНН - Анализ бизнеса</title>
    <!-- pdfmake + встроенные шрифты Roboto -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.72/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.72/vfs_fonts.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        /* Светлая тема */
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f1f5f9;
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --accent-primary: #3b82f6;
        --accent-secondary: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --border: #e2e8f0;
        --shadow: rgba(15, 23, 42, 0.1);
        --shadow-lg: rgba(15, 23, 42, 0.15);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          /* Темная тема */
          --bg-primary: #0f172a;
          --bg-secondary: #1e293b;
          --bg-tertiary: #334155;
          --text-primary: #f1f5f9;
          --text-secondary: #cbd5e1;
          --text-muted: #94a3b8;
          --accent-primary: #60a5fa;
          --accent-secondary: #a78bfa;
          --success: #34d399;
          --warning: #fbbf24;
          --error: #f87171;
          --border: #475569;
          --shadow: rgba(0, 0, 0, 0.3);
          --shadow-lg: rgba(0, 0, 0, 0.4);
        }
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        padding: 20px;
        transition: all 0.3s ease;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        animation: slideUp 0.8s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 30px;
        background: linear-gradient(
          135deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        border-radius: 24px;
        box-shadow: 0 20px 40px var(--shadow-lg);
        color: white;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="70" cy="30" r="2.5" fill="rgba(255,255,255,0.1)"/></svg>');
        animation: float 20s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 12px;
        position: relative;
        z-index: 1;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
      }

      .search-section {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px var(--shadow);
        border: 1px solid var(--border);
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 12px;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
      }

      .form-group.small label {
        font-size: 0.95rem;
      }

      /* Добавить в стили */
      .custom-select {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .custom-select select {
        width: 100%;
        padding: 12px 40px 12px 16px;
        border: 2px solid var(--border);
        border-radius: 16px;
        font-size: 14px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        appearance: none;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .custom-select select:focus {
        outline: none;
        border-color: var(--accent-primary);
        background: var(--bg-secondary);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }

      .custom-select::after {
        content: "▼";
        position: absolute;
        top: 50%;
        right: 16px;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--text-secondary);
        font-size: 12px;
      }

      .input-wrapper {
        position: relative;
      }

      .form-group input {
        width: 100%;
        padding: 18px 24px;
        border: 2px solid var(--border);
        border-radius: 16px;
        font-size: 18px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }

      .form-group.small input {
        padding: 12px 16px;
        font-size: 14px;
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--accent-primary);
        background: var(--bg-secondary);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
      }

      .calculation-params {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(139, 92, 246, 0.05)
        );
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(59, 130, 246, 0.2);
      }

      .calculation-params h3 {
        font-size: 1.1rem;
        color: var(--text-primary);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .calculation-params p {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 5px; /* Уменьшенный отступ с 10px до 5px */
      }

      .search-btn {
        background: linear-gradient(
          135deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        color: white;
        border: none;
        padding: 18px 40px;
        border-radius: 16px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      }

      .search-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
      }

      .search-btn:active {
        transform: translateY(-1px);
      }

      .search-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      #loading {
        display: none;
        text-align: center;
        padding: 40px;
        background: var(--bg-secondary);
        border-radius: 16px;
        margin: 20px 0;
        border: 1px solid var(--border);
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: linear-gradient(135deg, var(--error), #dc2626);
        color: white;
        padding: 20px 24px;
        border-radius: 16px;
        margin: 20px 0;
        display: none;
        text-align: center;
        font-weight: 500;
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
      }

      #results {
        display: none;
      }

      .result-card {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px var(--shadow);
        border: 1px solid var(--border);
        transition: all 0.3s ease;
      }

      .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px var(--shadow-lg);
      }

      .company-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--border);
      }

      .company-name {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 10px;
      }

      .company-director {
        font-size: 1.2rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* PDF кнопка */
      .pdf-section {
        text-align: center;
        margin: 20px 0;
      }

      .pdf-btn {
        background: linear-gradient(135deg, var(--success), #059669);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 16px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .pdf-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);
      }

      .pdf-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: var(--bg-tertiary);
        border-radius: 16px;
        padding: 24px;
        border-left: 4px solid var(--accent-primary);
        transition: all 0.3s ease;
      }

      .metric-card:hover {
        background: var(--bg-secondary);
        transform: translateX(5px);
      }

      .metric-card.financial {
        border-left-color: var(--success);
      }

      .metric-card.calculated {
        border-left-color: var(--accent-secondary);
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.1),
          rgba(99, 102, 241, 0.1)
        );
      }

      .metric-card.profitability {
        border-left-color: var(--warning);
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.1),
          rgba(217, 119, 6, 0.1)
        );
      }

      .metric-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .metric-value {
        font-size: 1.1rem;
        color: var(--text-primary);
        font-weight: 500;
      }

      .metric-note {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-style: italic;
        margin-top: 6px;
      }

      .growth-positive {
        color: var(--success);
        font-weight: 600;
      }

      .growth-negative {
        color: var(--error);
        font-weight: 600;
      }

      /* Параметры расчета - компактная версия */
      .parameters-section {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 20px 0;
        margin: 16px 0;
      }

      .parameters-grid {
        display: grid;
        gap: 12px; /* Уменьшили отступы */
        grid-template-columns: 1fr;
      }

      /* Для планшетов и десктопов */
      @media (min-width: 1024px) {
        .parameters-grid {
          grid-template-columns: 1fr 1fr 1fr; /* Все в одну строку */
          gap: 16px;
        }

        .parameters-section {
          padding: 24px 0;
        }
      }

      /* Компактные поля */
      .form-group.compact {
        margin-bottom: 8px; /* Уменьшили с 16px */
      }

      .form-group.compact label {
        font-size: 13px;
        margin-bottom: 6px; /* Уменьшили с 8px */
      }

      .form-group.compact input,
      .form-group.compact select {
        padding: 10px 14px; /* Уменьшили padding */
        font-size: 14px;
      }

      /* Кастомный select */
      .custom-select {
        position: relative;
      }

      .custom-select select {
        width: 100%;
        padding: 10px 35px 10px 14px;
        border: 2px solid var(--border);
        border-radius: 12px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 14px;
        appearance: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .custom-select select:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .custom-select::after {
        content: "▼";
        position: absolute;
        top: 50%;
        right: 12px;
        transform: translateY(-50%);
        pointer-events: none;
        color: var(--text-secondary);
        font-size: 10px;
      }

      .section {
        margin: 30px 0;
      }

      .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }

      .info-item {
        background: var(--bg-tertiary);
        padding: 16px 20px;
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .info-item:hover {
        background: var(--bg-secondary);
      }

      .info-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 4px;
      }

      .info-value {
        color: var(--text-primary);
        font-weight: 500;
      }

      .procurement-section {
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.1),
          rgba(99, 102, 241, 0.05)
        );
        border-radius: 16px;
        padding: 25px;
        border: 1px solid rgba(139, 92, 246, 0.2);
      }

      .customer-item {
        background: var(--bg-secondary);
        margin: 12px 0;
        padding: 16px 20px;
        border-radius: 12px;
        border-left: 3px solid var(--accent-secondary);
        transition: all 0.3s ease;
      }

      .customer-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px var(--shadow);
      }

      .customer-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
      }

      .customer-stats {
        color: var(--text-secondary);
        font-size: 0.95rem;
      }

      .summary-section {
        background: linear-gradient(
          135deg,
          rgba(245, 158, 11, 0.1),
          rgba(217, 119, 6, 0.05)
        );
        border-radius: 16px;
        padding: 25px;
        border: 1px solid rgba(245, 158, 11, 0.2);
      }

      .summary-section p {
        margin: 12px 0;
        line-height: 1.7;
        color: var(--text-secondary);
      }

      /* AI-сводка стили */
      .ai-summary-section {
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.15),
          rgba(59, 130, 246, 0.1)
        );
        border-radius: 20px;
        padding: 30px;
        border: 1px solid rgba(139, 92, 246, 0.3);
        margin-top: 30px;
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
        position: relative;
        overflow: hidden;
      }

      .ai-summary-section::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="10" cy="10" r="1.5" fill="rgba(139,92,246,0.2)"/><circle cx="90" cy="20" r="2" fill="rgba(139,92,246,0.15)"/><circle cx="30" cy="90" r="1" fill="rgba(139,92,246,0.25)"/><circle cx="80" cy="80" r="1.8" fill="rgba(139,92,246,0.2)"/></svg>');
        animation: aiFloat 25s ease-in-out infinite;
        pointer-events: none;
      }

      @keyframes aiFloat {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
        }
        50% {
          transform: translateY(-15px) rotate(180deg);
        }
      }

      .ai-summary-section .section-title {
        background: linear-gradient(
          135deg,
          var(--accent-secondary),
          var(--accent-primary)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        color: transparent;
        font-size: 1.4rem;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        z-index: 1;
      }

      .ai-summary-content {
        position: relative;
        z-index: 1;
      }

      .ai-summary-content p {
        margin: 15px 0;
        line-height: 1.8;
        color: var(--text-primary);
        font-size: 1rem;
        text-align: justify;
      }

      .ai-summary-content p:first-child {
        margin-top: 0;
      }

      .ai-summary-content p:last-child {
        margin-bottom: 0;
      }

      .profitability-highlight {
        background: linear-gradient(135deg, var(--warning), #d97706);
        color: white;
        padding: 20px;
        border-radius: 16px;
        text-align: center;
        margin: 20px 0;
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
      }

      .profitability-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .profitability-label {
        opacity: 0.9;
        font-size: 0.95rem;
      }

      .branding {
        text-align: center;
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-top: 20px;
        padding: 15px;
        background: var(--bg-tertiary);
        border-radius: 10px;
      }

      /* Адаптивность */
      @media (max-width: 768px) {
        .container {
          padding: 0 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .search-section {
          padding: 25px;
        }

        .result-card {
          padding: 20px;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .info-grid {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
          gap: 15px;
        }

        .ai-summary-section {
          padding: 20px;
        }

        .ai-summary-section .section-title {
          font-size: 1.2rem;
        }
      }

      /* Анимации при скролле */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeInUp 0.6s ease-out forwards;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🏢 Анализ компании по ИНН</h1>
      </div>

      <div class="search-section">
        <div class="form-group">
          <label for="inn">ИНН компании:</label>
          <div class="input-wrapper">
            <input
              type="text"
              id="inn"
              placeholder="Введите 10 или 12-значный ИНН"
              maxlength="12"
            />
          </div>
        </div>

        <div class="parameters-section">
          <h3><span class="icon">⚙️</span> Параметры расчета</h3>

          <div class="parameters-grid">
            <!-- Профиль/пресет -->
            <div class="form-group compact">
              <label>Профиль/пресет:</label>
              <div class="custom-select">
                <select id="preset-select" onchange="applyPreset()">
                  <option value="">Выберите профиль</option>
                  <option value="design_classic">
                    Классическое проектное бюро
                  </option>
                  <option value="design_arch">
                    Проектное бюро с генподрядом
                  </option>
                  <option value="system_integrator">Строитель ЦОД</option>
                  <option value="gen_contract">Генподрядчик</option>
                  <option value="developer">Девелопер</option>
                </select>
              </div>
            </div>

            <!-- Субподряд -->
            <div class="form-group compact">
              <label>Процент работ на субподряде (%):</label>
              <input
                type="number"
                id="subcontract-percent"
                value="50"
                min="0"
                max="100"
                oninput="updateCalculations()"
              />
            </div>

            <!-- Операционные расходы -->
            <div class="form-group compact">
              <label>Процент операционных расходов (%):</label>
              <input
                type="number"
                id="operational-percent"
                value="15"
                min="0"
                max="100"
                oninput="updateCalculations()"
              />
            </div>
          </div>

          <div class="info-tip">
            <span class="icon">💡</span>
            <span
              >Эти параметры влияют на точность расчета рентабельности.</span
            >
          </div>
        </div>

        <button class="search-btn" onclick="searchCompany()" id="searchButton">
          🔍 Анализировать компанию
        </button>
      </div>

      <div id="loading">
        <div class="spinner"></div>
        <p>Собираем и анализируем данные...</p>
      </div>

      <div class="error" id="error-message"></div>

      <div id="results">
        <div class="result-card fade-in">
          <div id="company-content">
            <!-- Результаты будут отображены здесь -->
          </div>
          <div class="pdf-section">
            <button
              class="pdf-btn"
              onclick="generatePDF()"
              id="pdfButton"
              disabled
            >
              📄 Скачать PDF-отчёт
            </button>
          </div>
        </div>
        <div class="branding">Разработчик: Игорь Ромашов. Версия: 2.1 beta</div>
      </div>
    </div>

    <script>
      let currentCompanyData = null;

      const presets = {
        design_classic: {
          sub: [20, 30],
          op: [15, 20],
          rent: [15, 25],
          label: "Высокая",
        },
        design_arch: {
          sub: [40, 70],
          op: [10, 15],
          rent: [10, 18],
          label: "Средняя",
        },
        system_integrator: {
          sub: [50, 80],
          op: [10, 15],
          rent: [5, 12],
          label: "Низкая",
        },
        gen_contract: {
          sub: [60, 90],
          op: [5, 10],
          rent: [2, 8],
          label: "Очень низкая",
        },
        developer: {
          sub: [0, 0],
          op: [2, 5],
          rent: [15, 30],
          label: "Высокая",
        },
      };

      function applyPreset() {
        const preset = presets[document.getElementById("preset-select").value];
        if (!preset) return;
        // Берём средние
        if (preset.sub.length) {
          document.getElementById("subcontract-percent").value = Math.round(
            (preset.sub[0] + preset.sub[1]) / 2
          );
        }
        if (preset.op.length) {
          document.getElementById("operational-percent").value = Math.round(
            (preset.op[0] + preset.op[1]) / 2
          );
        }
        if (
          currentCompanyData &&
          document.getElementById("results").style.display !== "none"
        ) {
          displayResults(currentCompanyData);
        }
      }

      async function searchCompany() {
        const inn = document.getElementById("inn").value.trim();
        if (!/^\d{10}$|^\d{12}$/.test(inn)) {
          showError("Введите корректный ИНН (10 или 12 цифр)");
          return;
        }

        showLoading(true);
        hideError();
        document.getElementById("results").style.display = "none";
        document.getElementById("pdfButton").disabled = true;

        try {
          // Обновлённый список прокси для большей надёжности
          const proxies = [
            "https://api.allorigins.win/get?url=",
            "https://corsproxy.io/?",
            "https://api.codetabs.com/v1/proxy?quest=",
            "https://thingproxy.freeboard.io/fetch/",
          ];

          const targetUrl = `https://www.rusprofile.ru/search?query=${inn}`;
          let html = await fetchWithRetry(proxies, targetUrl);

          if (!html || typeof html !== "string" || !html.includes("<html")) {
            throw new Error(
              "Все прокси-сервера недоступны или вернули некорректные данные"
            );
          }

          // Логируем части HTML для отладки
          console.log("Первые 500 символов HTML:", html.substring(0, 500));

          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          // Проверяем основные элементы
          console.log(
            "Найдено элементов h1:",
            doc.querySelectorAll("h1").length
          );
          console.log(
            "Найдено элементов .company-name:",
            doc.querySelectorAll(".company-name").length
          );
          console.log(
            "Найдено элементов #anketa:",
            doc.querySelectorAll("#anketa").length
          );

          // Ищем детальную страницу компании
          const companyInfo =
            doc.querySelector("#anketa") || doc.querySelector(".company-info");

          if (companyInfo) {
            console.log("Найдена детальная страница компании");
            const detailedData = extractDetailedCompanyData(doc);
            currentCompanyData = detailedData;
            displayResults(detailedData);
            document.getElementById("pdfButton").disabled = false;
            return;
          }

          // Ищем в результатах поиска с более общими селекторами
          const searchResults = [
            ".search-result__item",
            ".company-item",
            "[data-company-id]",
            ".search-item",
            ".company-preview",
          ];

          let companyBlock = null;
          for (const selector of searchResults) {
            companyBlock = doc.querySelector(selector);
            if (companyBlock) {
              console.log(`Найден результат поиска по селектору: ${selector}`);
              break;
            }
          }

          if (!companyBlock) {
            // Попробуем найти любую ссылку на компанию с улучшенной логикой
            const companyLinks = doc.querySelectorAll('a[href*="/id/"]');
            console.log("Найдено ссылок на компании:", companyLinks.length);
            if (companyLinks.length > 0) {
              // Переходим на первую найденную компанию
              const companyUrl =
                "https://www.rusprofile.ru" +
                companyLinks[0].getAttribute("href");
              console.log("Переходим на страницу компании:", companyUrl);

              // Повторный запрос за детальными данными с ретраем
              html = await fetchWithRetry(proxies, companyUrl);

              const detailDoc = parser.parseFromString(html, "text/html");

              const detailedData = extractDetailedCompanyData(detailDoc);
              currentCompanyData = detailedData;
              displayResults(detailedData);
              document.getElementById("pdfButton").disabled = false;
              return;
            }

            throw new Error(
              "Компания с указанным ИНН не найдена. Проверьте корректность ИНН."
            );
          }

          // Если нашли блок компании, но это не детальная страница
          console.log("Извлекаем данные из результатов поиска");
          const companyData = extractCompanyData(companyBlock, doc);
          currentCompanyData = companyData;
          displayResults(companyData);
          document.getElementById("pdfButton").disabled = false;
        } catch (error) {
          console.error("Ошибка получения данных:", error);
          showError(`Ошибка получения данных: ${error.message}. 
      Возможные причины:
      • Проблемы с интернет-соединением
      • Сайт RusProfile временно недоступен  
      • Компания с таким ИНН не найдена
      • Попробуйте позже или проверьте ИНН`);
        } finally {
          showLoading(false);
        }
      }

      // Новая функция для fetch с ретраями и проверкой
      async function fetchWithRetry(proxies, url, retries = 2) {
        for (let attempt = 0; attempt <= retries; attempt++) {
          for (const proxy of proxies) {
            try {
              console.log(`Пробуем прокси: ${proxy} (попытка ${attempt + 1})`);
              const fullUrl = proxy + encodeURIComponent(url);

              const response = await fetch(fullUrl, {
                method: "GET",
                headers: {
                  "User-Agent":
                    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
                },
                timeout: 15000,
              });

              if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
              }

              const data = await response.json();
              const html = data.contents || data.body || data || data.data;

              // Проверка на валидный HTML
              if (typeof html === "string" && html.includes("<html")) {
                console.log(`Успешно получили данные через: ${proxy}`);
                console.log(`Размер ответа: ${html.length} символов`);
                return html;
              } else {
                throw new Error("Ответ не содержит валидный HTML");
              }
            } catch (error) {
              console.warn(`Прокси ${proxy} недоступен:`, error);
              continue;
            }
          }
        }
        throw new Error("Все попытки fetch провалились");
      }

      // Функция для тестирования прокси (для отладки)
      async function testProxies() {
        const proxies = [
          "https://api.allorigins.win/get?url=",
          "https://corsproxy.io/?",
          "https://api.codetabs.com/v1/proxy?quest=",
        ];

        console.log("Тестируем доступность прокси-серверов...");

        for (const proxy of proxies) {
          try {
            const testUrl =
              proxy + encodeURIComponent("https://httpbin.org/json");
            const response = await fetch(testUrl, { timeout: 5000 });
            console.log(`✅ Прокси ${proxy} - доступен (${response.status})`);
          } catch (error) {
            console.log(`❌ Прокси ${proxy} - недоступен:`, error.message);
          }
        }
      }

      function calculateFinancialMetrics(data) {
        const calculations = {
          revenue2023: null,
          revenue2024: null,
          fotWithContributions2023: null,
          fotWithContributions2024: null,
          subcontractCosts2024: null,
          operationalCosts2024: null,
          profitBeforeTax2024: null,
          netProfit2024: null,
          profitability: null,
        };

        if (!data.taxes) return calculations;

        const parseGrowth = (str) => {
          if (!str) return 0;
          const match = str.match(/([+-]?\d+)\s*%/);
          if (!match) return 0;
          return parseInt(match[1]) / 100;
        };

        const subcontractPercent =
          parseInt(document.getElementById("subcontract-percent").value) / 100;
        const operationalPercent =
          parseInt(document.getElementById("operational-percent").value) / 100;

        const currentRevenue = parseAmount(data.revenue);
        const revenueGrowthRate = parseGrowth(data.revenueGrowth);
        const feesAmount = parseAmount(data.taxes.fees);

        if (currentRevenue > 0 && revenueGrowthRate !== 0) {
          calculations.revenue2023 = currentRevenue / (1 + revenueGrowthRate);
        }
        calculations.revenue2024 = currentRevenue;

        if (feesAmount > 0) {
          calculations.fotWithContributions2023 = (feesAmount / 0.3) * 1.3;
        }
        if (calculations.fotWithContributions2023 && revenueGrowthRate !== 0) {
          calculations.fotWithContributions2024 =
            calculations.fotWithContributions2023 * (1 + revenueGrowthRate);
        }

        if (currentRevenue > 0) {
          calculations.subcontractCosts2024 =
            currentRevenue * subcontractPercent;
          calculations.operationalCosts2024 =
            currentRevenue * operationalPercent;
        }

        if (
          calculations.revenue2024 &&
          calculations.fotWithContributions2024 &&
          calculations.subcontractCosts2024 &&
          calculations.operationalCosts2024
        ) {
          calculations.profitBeforeTax2024 =
            calculations.revenue2024 -
            calculations.fotWithContributions2024 -
            calculations.subcontractCosts2024 -
            calculations.operationalCosts2024;
        }

        if (calculations.profitBeforeTax2024 > 0) {
          calculations.netProfit2024 = calculations.profitBeforeTax2024 * 0.8;
        }

        if (calculations.netProfit2024 && calculations.revenue2024 > 0) {
          calculations.profitability =
            (calculations.netProfit2024 / calculations.revenue2024) * 100;
        }

        return calculations;
      }

      function getDefaultLogo() {
        const canvas = document.createElement("canvas");
        canvas.width = 100;
        canvas.height = 100;
        const ctx = canvas.getContext("2d");

        ctx.fillStyle = "#3b82f6";
        ctx.fillRect(0, 0, 100, 100);

        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 24px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ИР", 50, 50);

        return canvas.toDataURL("image/png");
      }

      async function loadLogo() {
        try {
          const response = await fetch("logo.svg");
          if (response.ok) {
            const svgText = await response.text();
            return (
              "data:image/svg+xml;base64," +
              btoa(unescape(encodeURIComponent(svgText)))
            );
          }
        } catch (error) {
          console.warn("Логотип logo.svg не найден, используем стандартный");
        }

        return getDefaultLogo();
      }

      function compareProfitability(pct, presetKey) {
        if (
          !presetKey ||
          !presets[presetKey] ||
          !presets[presetKey].rent.length
        )
          return "";
        const [min, max] = presets[presetKey].rent;
        if (pct == null) return "";
        let label = "";
        if (pct < min) label = "🚨 Ниже нормы для отрасли";
        else if (pct > max) label = "🟢 Выше нормы для отрасли";
        else
          label = `✅ ${presets[presetKey].label} для отрасли (${min}–${max}%)`;
        return `<div class="metric-note">${label}</div>`;
      }

      async function generatePDF() {
        if (!currentCompanyData) {
          showError("Нет данных для создания отчёта");
          return;
        }

        const btn = document.getElementById("pdfButton");
        btn.disabled = true;
        btn.innerHTML = "📄 Создаём PDF…";

        try {
          if (typeof pdfMake === "undefined") {
            throw new Error("Библиотека pdfMake не загружена");
          }

          const calc = calculateFinancialMetrics(currentCompanyData);

          // Очищаем название компании для файла
          const cleanName = currentCompanyData.name
            ? currentCompanyData.name
                .replace(/[^\u0400-\u04FF\w\s]/g, "") // Только кириллица, латиница, цифры, пробелы
                .trim()
                .substring(0, 30) // Ограничиваем длину
            : "Компания";

          const content = [
            // Заголовок
            {
              text: "БИЗНЕС-АНАЛИТИКА КОМПАНИИ",
              style: "header",
              alignment: "center",
              margin: [0, 0, 0, 20],
            },

            // Название компании
            {
              text: currentCompanyData.name || "Неизвестная компания",
              style: "title",
              margin: [0, 0, 0, 10],
            },

            // Директор
            {
              text: `Генеральный директор: ${
                currentCompanyData.director || "Не найдено"
              }`,
              style: "subtitle",
              margin: [0, 0, 0, 20],
            },

            // Рентабельность (большой блок)
            ...(calc.profitability
              ? [
                  {
                    table: {
                      widths: ["*"],
                      body: [
                        [
                          {
                            text: `Рентабельность бизнеса: ${calc.profitability.toFixed(
                              2
                            )}%`,
                            style: "profitability",
                            alignment: "center",
                            fillColor: "#F59E0B",
                            color: "white",
                          },
                        ],
                      ],
                    },
                    layout: "noBorders",
                    margin: [0, 0, 0, 20],
                  },
                ]
              : []),
          ];

          // Основные финансовые показатели
          content.push({
            text: "Основные финансовые показатели",
            style: "subheader",
            margin: [0, 0, 0, 10],
          });

          const mainMetrics = [];
          if (currentCompanyData.revenue !== "Не найдено") {
            mainMetrics.push([
              "Выручка 2024",
              `${currentCompanyData.revenue}${
                currentCompanyData.revenueGrowth
                  ? " (" + currentCompanyData.revenueGrowth + ")"
                  : ""
              }`,
            ]);
          }
          if (calc.netProfit2024) {
            mainMetrics.push([
              "Чистая прибыль 2024",
              formatAmountForPDF(calc.netProfit2024),
            ]);
          }
          if (calc.fotWithContributions2024) {
            mainMetrics.push([
              "ФОТ + взносы 2024",
              formatAmountForPDF(calc.fotWithContributions2024),
            ]);
          }
          if (currentCompanyData.profitGrowth) {
            mainMetrics.push(["Рост прибыли", currentCompanyData.profitGrowth]);
          }
          if (currentCompanyData.valueGrowth) {
            mainMetrics.push([
              "Рост стоимости компании",
              currentCompanyData.valueGrowth,
            ]);
          }

          if (mainMetrics.length > 0) {
            content.push({
              table: {
                widths: ["60%", "40%"],
                headerRows: 1,
                body: [
                  [
                    { text: "Показатель", style: "tableHeader" },
                    { text: "Значение", style: "tableHeader" },
                  ],
                  ...mainMetrics,
                ],
              },
              layout: "lightHorizontalLines",
              margin: [0, 0, 0, 20],
            });
          }

          // Детальные расчеты
          content.push({
            text: "Детальные расчеты рентабельности",
            style: "subheader",
            margin: [0, 0, 0, 10],
          });

          const calcMetrics = [
            [
              { text: "Показатель", style: "tableHeader" },
              { text: "Значение", style: "tableHeader" },
            ],
          ];

          if (calc.revenue2024) {
            calcMetrics.push([
              "Выручка 2024",
              formatAmountForPDF(calc.revenue2024),
            ]);
          }
          if (calc.fotWithContributions2024) {
            calcMetrics.push([
              "ФОТ + взносы 2024",
              formatAmountForPDF(calc.fotWithContributions2024),
            ]);
          }
          if (calc.subcontractCosts2024) {
            calcMetrics.push([
              `Субподрядные работы (${
                document.getElementById("subcontract-percent").value
              }%)`,
              formatAmountForPDF(calc.subcontractCosts2024),
            ]);
          }
          if (calc.operationalCosts2024) {
            calcMetrics.push([
              `Операционные расходы (${
                document.getElementById("operational-percent").value
              }%)`,
              formatAmountForPDF(calc.operationalCosts2024),
            ]);
          }
          if (calc.profitBeforeTax2024) {
            calcMetrics.push([
              "Прибыль до налога",
              formatAmountForPDF(calc.profitBeforeTax2024),
            ]);
          }
          if (calc.netProfit2024) {
            calcMetrics.push([
              "Чистая прибыль (-20% налог)",
              formatAmountForPDF(calc.netProfit2024),
            ]);
          }

          content.push({
            table: {
              widths: ["60%", "40%"],
              body: calcMetrics,
            },
            layout: "lightHorizontalLines",
            margin: [0, 0, 0, 20],
          });

          // Реквизиты компании
          content.push({
            text: "Реквизиты компании",
            style: "subheader",
            margin: [0, 0, 0, 10],
          });

          content.push({
            columns: [
              [
                { text: "ИНН:", bold: true },
                {
                  text: currentCompanyData.inn || "Не найдено",
                  margin: [0, 0, 0, 5],
                },
                { text: "ОГРН:", bold: true },
                {
                  text: currentCompanyData.ogrn || "Не найдено",
                  margin: [0, 0, 0, 10],
                },
              ],
              [
                { text: "Дата регистрации:", bold: true },
                {
                  text: currentCompanyData.registrationDate || "Не найдено",
                  margin: [0, 0, 0, 5],
                },
                { text: "Уставный капитал:", bold: true },
                { text: currentCompanyData.capital || "Не найдено" },
              ],
            ],
            margin: [0, 0, 0, 15],
          });

          // Юридический адрес
          if (
            currentCompanyData.address &&
            currentCompanyData.address !== "Не найдено"
          ) {
            content.push({
              text: "Юридический адрес:",
              bold: true,
              margin: [0, 0, 0, 5],
            });
            content.push({
              text: currentCompanyData.address,
              margin: [0, 0, 0, 15],
            });
          }

          // Исходные данные
          if (currentCompanyData.taxes) {
            content.push({
              text: `Исходные налоговые данные (${currentCompanyData.taxes.year})`,
              style: "subheader",
              margin: [0, 0, 0, 10],
            });

            const taxData = [];
            if (currentCompanyData.taxes.taxes) {
              taxData.push(["Налоги", currentCompanyData.taxes.taxes]);
            }
            if (currentCompanyData.taxes.fees) {
              taxData.push(["Взносы", currentCompanyData.taxes.fees]);
            }

            if (taxData.length > 0) {
              content.push({
                table: {
                  widths: ["50%", "50%"],
                  body: [
                    [
                      { text: "Тип платежа", style: "tableHeader" },
                      { text: "Сумма", style: "tableHeader" },
                    ],
                    ...taxData,
                  ],
                },
                layout: "lightHorizontalLines",
                margin: [0, 0, 0, 15],
              });
            }
          }

          // Государственные закупки
          if (
            currentCompanyData.procurement &&
            currentCompanyData.procurement.customers.length > 0
          ) {
            content.push({
              text: "Государственные закупки",
              style: "subheader",
              margin: [0, 0, 0, 10],
            });

            content.push({
              text: `В роли: ${currentCompanyData.procurement.role}`,
              bold: true,
              margin: [0, 0, 0, 10],
            });

            const procurementData = [
              [
                { text: "Заказчик", style: "tableHeader" },
                { text: "Контракты и сумма", style: "tableHeader" },
              ],
            ];

            currentCompanyData.procurement.customers
              .slice(0, 5)
              .forEach((customer) => {
                procurementData.push([
                  customer.name,
                  `${customer.contracts} на ${customer.amount}`,
                ]);
              });

            content.push({
              table: {
                widths: ["60%", "40%"],
                body: procurementData,
              },
              layout: "lightHorizontalLines",
              margin: [0, 0, 0, 10],
            });

            if (currentCompanyData.procurement.totalContracts > 0) {
              content.push({
                text: `Всего участвовала в ${currentCompanyData.procurement.totalContracts} закупках на сумму ${currentCompanyData.procurement.totalAmount}`,
                alignment: "center",
                bold: true,
                margin: [0, 10, 0, 15],
              });
            }
          }

          // Краткая справка
          if (currentCompanyData.summary) {
            content.push({
              text: "Справочная информация",
              style: "subheader",
              margin: [0, 0, 0, 10],
            });

            const summaryParagraphs = currentCompanyData.summary.split("\n\n");
            summaryParagraphs.forEach((paragraph) => {
              if (paragraph.trim()) {
                content.push({
                  text: paragraph.trim(),
                  margin: [0, 0, 0, 8],
                });
              }
            });
          }

          // Примечание: AI-сводка в PDF не добавляется согласно требованию

          const docDefinition = {
            content: content,

            styles: {
              header: {
                fontSize: 16,
                bold: true,
                color: "#3b82f6",
              },
              title: {
                fontSize: 14,
                bold: true,
              },
              subtitle: {
                fontSize: 12,
                color: "#666666",
              },
              subheader: {
                fontSize: 12,
                bold: true,
                margin: [0, 15, 0, 5],
              },
              profitability: {
                fontSize: 16,
                bold: true,
                margin: [0, 10],
              },
              tableHeader: {
                bold: true,
                fillColor: "#3b82f6",
                color: "white",
              },
            },

            defaultStyle: {
              fontSize: 10,
            },

            footer: {
              columns: [
                {
                  text: "Разработчик: Игорь Ромашов · Версия 2.2 beta",
                  fontSize: 8,
                  color: "#666666",
                },
                {
                  text: new Date().toLocaleDateString("ru-RU"),
                  alignment: "right",
                  fontSize: 8,
                  color: "#666666",
                },
              ],
              margin: [40, 10],
            },
          };

          // Правильное название файла
          const fileName = `Анализ_${cleanName}_${new Date()
            .toLocaleDateString("ru-RU")
            .replace(/\./g, "-")}.pdf`;

          pdfMake.createPdf(docDefinition).download(fileName);
        } catch (error) {
          console.error("Ошибка PDF:", error);
          showError(`Ошибка создания PDF: ${error.message}`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = "📄 Скачать PDF-отчёт";
        }
      }

      // Вспомогательная функция форматирования для PDF
      function formatAmountForPDF(amount) {
        if (!amount || amount === 0) return "0 руб.";

        if (amount >= 1000000000) {
          return `${(amount / 1000000000).toFixed(1)} млрд руб.`;
        } else if (amount >= 1000000) {
          return `${(amount / 1000000).toFixed(1)} млн руб.`;
        } else if (amount >= 1000) {
          return `${(amount / 1000).toFixed(1)} тыс руб.`;
        } else {
          return `${Math.round(amount)} руб.`;
        }
      }

      // Функция форматирования сумм на русском языке для PDF
      function formatAmountRussian(amount) {
        if (!amount || amount === 0) return "0";

        if (amount >= 1000000000) {
          return `${(amount / 1000000000).toFixed(1)} млрд руб.`;
        } else if (amount >= 1000000) {
          return `${(amount / 1000000).toFixed(1)} млн руб.`;
        } else if (amount >= 1000) {
          return `${(amount / 1000).toFixed(1)} тыс руб.`;
        } else {
          return `${amount.toFixed(0)} руб.`;
        }
      }

      // Функция транслитерации для резервного случая
      function transliterate(text) {
        const map = {
          а: "a",
          б: "b",
          в: "v",
          г: "g",
          д: "d",
          е: "e",
          ё: "yo",
          ж: "zh",
          з: "z",
          и: "i",
          й: "j",
          к: "k",
          л: "l",
          м: "m",
          н: "n",
          о: "o",
          п: "p",
          р: "r",
          с: "s",
          т: "t",
          у: "u",
          ф: "f",
          х: "h",
          ц: "c",
          ч: "ch",
          ш: "sh",
          щ: "sch",
          ъ: "",
          ы: "y",
          ь: "",
          э: "e",
          ю: "yu",
          я: "ya",
          А: "A",
          Б: "B",
          В: "V",
          Г: "G",
          Д: "D",
          Е: "E",
          Ё: "Yo",
          Ж: "Zh",
          З: "Z",
          И: "I",
          Й: "J",
          К: "K",
          Л: "L",
          М: "M",
          Н: "N",
          О: "O",
          П: "P",
          Р: "R",
          С: "S",
          Т: "T",
          У: "U",
          Ф: "F",
          Х: "H",
          Ц: "C",
          Ч: "Ch",
          Ш: "Sh",
          Щ: "Sch",
          Ъ: "",
          Ы: "Y",
          Ь: "",
          Э: "E",
          Ю: "Yu",
          Я: "Ya",
        };

        return text
          .split("")
          .map((char) => map[char] || char)
          .join("");
      }

      function extractDetailedCompanyData(doc) {
        let name = "Не найдено";
        let director = "Не найдено";
        let revenue = "Не найдено";
        let revenueGrowth = "";
        let profitGrowth = "";
        let valueGrowth = "";
        let ogrn = "Не найдено";
        let innFound = "Не найдено";
        let address = "Не найдено";
        let registrationDate = "Не найдено";
        let capital = "Не найдено";
        let summary = "";
        let procurement = null;
        let taxes = null;
        let aiSummary = ""; // Добавляем AI-сводку

        // Название компании (улучшенный селектор)
        const titleElement =
          doc.querySelector("h1[itemprop='name']") ||
          doc.querySelector(".company-name") ||
          doc.querySelector("h1");
        if (titleElement) {
          name = titleElement.textContent.trim();
        }

        if (name === "Не найдено") {
          const descriptionText =
            doc.querySelector(".information-text")?.textContent || "";
          const nameMatch = descriptionText.match(
            /Генеральный директор ([^-]+) -/
          );
          if (nameMatch) {
            name = nameMatch[1].trim();
          }
        }

        // Директор (улучшенный селектор)
        const managerBlock =
          doc.querySelector("[itemprop='founder']") ||
          doc.querySelector(".company-info__item");
        if (managerBlock) {
          const chiefTitle =
            managerBlock.querySelector(".chief-title") ||
            managerBlock.querySelector("[itemprop='jobTitle']");
          const managerLink =
            managerBlock.querySelector("a[itemprop='name']") ||
            managerBlock.querySelector("a");

          if (
            chiefTitle &&
            chiefTitle.textContent.includes("Генеральный директор") &&
            managerLink
          ) {
            const managerName = managerLink.textContent
              .trim()
              .replace(/подробнее.*/, "")
              .trim();
            if (managerName) {
              director = managerName;
            }
          }
        }

        if (director === "Не найдено") {
          const descriptionText =
            doc.querySelector(".information-text")?.textContent || "";
          const directorMatch = descriptionText.match(
            /Генеральный директор [^-]+ - ([^(]+)/
          );
          if (directorMatch) {
            director = directorMatch[1].trim();
          }
        }

        // Основные реквизиты (улучшенные селекторы)
        const ogrnElement =
          doc.querySelector("#clip_ogrn") ||
          doc.querySelector("[itemprop='ogrn']");
        if (ogrnElement) ogrn = ogrnElement.textContent.trim();

        const innElement =
          doc.querySelector("#clip_inn") ||
          doc.querySelector("[itemprop='taxID']");
        if (innElement) innFound = innElement.textContent.trim();

        const addressElement =
          doc.querySelector("#clip_address") ||
          doc.querySelector("[itemprop='address']");
        if (addressElement)
          address = addressElement.textContent.trim().replace(/\s+/g, " ");

        const regDateElement =
          doc.querySelector('[itemprop="foundingDate"]') ||
          doc.querySelector(".reg-date");
        if (regDateElement)
          registrationDate = regDateElement.textContent.trim();

        // Уставный капитал
        const allElements = doc.querySelectorAll(".company-info__text");
        for (const element of allElements) {
          if (
            element.textContent.includes("руб.") &&
            element.textContent.match(/\d+.*руб\./)
          ) {
            capital = element.textContent.trim();
            break;
          }
        }

        // Краткая справка
        const summaryBlock =
          doc.querySelector(".enquiry-tile") ||
          doc.querySelector(".company-summary");
        if (summaryBlock) {
          const summaryTexts = summaryBlock.querySelectorAll(
            ".enquiry-tile__text"
          );
          const summaryParts = [];
          summaryTexts.forEach((textElement) => {
            const text = textElement.textContent.trim();
            if (text) {
              summaryParts.push(text);
            }
          });
          summary = summaryParts.join("\n\n");
        }

        // AI-сводка (новый парсинг)
        const aiSummaryBlock = doc.querySelector(
          ".company-description__wrapper"
        );
        if (aiSummaryBlock) {
          const aiTextElement = aiSummaryBlock.querySelector(
            ".company-description__text"
          );
          if (aiTextElement) {
            // Извлекаем текст из всех параграфов
            const paragraphs = aiTextElement.querySelectorAll("p");
            const aiParts = [];
            paragraphs.forEach((paragraph) => {
              const text = paragraph.textContent.trim();
              if (text) {
                aiParts.push(text);
              }
            });
            aiSummary = aiParts.join("\n\n");

            console.log(
              "Найдена AI-сводка:",
              aiSummary.substring(0, 200) + "..."
            );
          }
        }

        // НАЛОГИ И СБОРЫ (улучшенный парсинг)
        const taxesBlock =
          doc.querySelector(".taxes-tile") ||
          doc.querySelector("[data-tile='taxes']");
        if (taxesBlock) {
          taxes = {
            year: "",
            taxes: "",
            fees: "",
          };

          const yearText = taxesBlock.textContent;
          const yearMatch = yearText.match(/за (\d{4}) год/);
          if (yearMatch) {
            taxes.year = yearMatch[1];
          }

          const allCols = taxesBlock.querySelectorAll(".connexion-col");

          allCols.forEach((col) => {
            const titleElement = col.querySelector(".connexion-col__title");
            const numElement = col.querySelector(".num");

            if (titleElement && numElement) {
              const title = titleElement.textContent.trim();
              const numValue = numElement.textContent.trim();
              const fullNumText =
                col.querySelector(".connexion-col__num")?.textContent.trim() ||
                "";

              if (title.includes("Налоги")) {
                const unitMatch = fullNumText.match(/млн|тыс|руб/);
                const unit = unitMatch ? unitMatch[0] : "руб";
                taxes.taxes = `${numValue} ${
                  unit === "млн"
                    ? "млн руб."
                    : unit === "тыс"
                    ? "тыс руб."
                    : "руб."
                }`;
              } else if (title.includes("Взносы")) {
                const unitMatch = fullNumText.match(/млн|тыс|руб/);
                const unit = unitMatch ? unitMatch[0] : "руб";
                taxes.fees = `${numValue} ${
                  unit === "млн"
                    ? "млн руб."
                    : unit === "тыс"
                    ? "тыс руб."
                    : "руб."
                }`;
              }
            }
          });
        }

        // ГОСЗАКУПКИ (улучшенный парсинг)
        const procurementBlock =
          doc.querySelector(".gz-tile") ||
          doc.querySelector("[data-tile='procurement']");
        if (procurementBlock) {
          procurement = {
            role: "",
            customers: [],
            totalContracts: 0,
            totalAmount: "",
          };

          const roleElement =
            procurementBlock.querySelector(".tab-opener.active") ||
            procurementBlock.querySelector(".role-tab");
          if (roleElement) {
            procurement.role = roleElement.textContent.trim();
          }

          const customerItems =
            procurementBlock.querySelectorAll(".founder-item") ||
            procurementBlock.querySelectorAll(".customer-block");
          customerItems.forEach((item) => {
            const nameElement =
              item.querySelector(".founder-item__title span") ||
              item.querySelector(".customer-name");
            const statsElement =
              item.querySelector(".founder-item__dl") ||
              item.querySelector(".customer-stats");

            if (nameElement && statsElement) {
              const name = nameElement.textContent.trim();
              const dtElement = statsElement.querySelector("dt");
              const ddElement = statsElement.querySelector("dd");

              if (dtElement && ddElement) {
                const contractsText = dtElement.textContent.trim();
                const amount = ddElement.textContent.trim();

                procurement.customers.push({
                  name: name,
                  contracts: contractsText,
                  amount: amount,
                });
              }
            }
          });

          const totalStatsText = procurementBlock.textContent;
          const totalMatch = totalStatsText.match(
            /участвовала.*?в (\d+).*?закупках.*?на сумму.*?([\d\s]+руб\.)/
          );
          if (totalMatch) {
            procurement.totalContracts = parseInt(totalMatch[1]);
            procurement.totalAmount = totalMatch[2].trim();
          }
        }

        // ФИНАНСОВЫЕ ДАННЫЕ (улучшенный парсинг)
        const financeBlock =
          doc.querySelector(".tile-finance-columns") ||
          doc.querySelector("[data-tile='finance']");
        if (financeBlock) {
          const revenueCol =
            financeBlock
              .querySelector('[data-tab_name="tab_revenue"]')
              ?.closest(".finance-col") ||
            financeBlock.querySelector(".revenue-col");
          if (revenueCol) {
            const numElement = revenueCol.querySelector(".num");
            const numTextElement = revenueCol.querySelector(".num-text");
            const diffElement = revenueCol.querySelector(".diff.mt");

            if (numElement && numTextElement) {
              const number = numElement.textContent.trim();
              const unit = numTextElement.textContent
                .trim()
                .replace(/&nbsp;/g, " ");
              revenue = `${number} ${unit}`;

              if (diffElement) {
                revenueGrowth = diffElement.textContent
                  .trim()
                  .replace(/\s+/g, " ");
              }
            }
          }

          const profitCol =
            financeBlock
              .querySelector('[data-tab_name="tab_profit"]')
              ?.closest(".finance-col") ||
            financeBlock.querySelector(".profit-col");
          if (profitCol) {
            const diffElement = profitCol.querySelector(".diff.mt");
            if (diffElement) {
              profitGrowth = diffElement.textContent
                .trim()
                .replace(/\s+/g, " ");
            }
          }

          const valueCol =
            financeBlock
              .querySelector('[data-tab_name="tab_value"]')
              ?.closest(".finance-col") ||
            financeBlock.querySelector(".value-col");
          if (valueCol) {
            const diffElement = valueCol.querySelector(".diff.mt");
            if (diffElement) {
              valueGrowth = diffElement.textContent.trim().replace(/\s+/g, " ");
            }
          }
        }

        return {
          name,
          director,
          revenue,
          revenueGrowth,
          profitGrowth,
          valueGrowth,
          ogrn,
          inn: innFound,
          address,
          registrationDate,
          capital,
          summary,
          procurement,
          taxes,
          aiSummary, // Добавляем AI-сводку к возвращаемым данным
          isDetailed: true,
        };
      }

      function extractCompanyData(companyBlock, doc) {
        return {
          name: "Найдена компания",
          director: "Данные загружаются...",
          revenue: "Данные загружаются...",
          isDetailed: false,
        };
      }

      function parseAmount(str) {
        if (!str) return 0;

        const numMatch = str.match(/([\d,\.]+)/);
        if (!numMatch) return 0;

        let number = parseFloat(numMatch[1].replace(",", "."));
        const lowerStr = str.toLowerCase();

        if (lowerStr.includes("млрд")) {
          number = number * 1000000000;
        } else if (lowerStr.includes("млн")) {
          number = number * 1000000;
        } else if (lowerStr.includes("тыс")) {
          number = number * 1000;
        }

        return number;
      }

      function formatAmount(amount) {
        if (!amount || amount === 0) return null;

        if (amount >= 1000000000) {
          return `${(amount / 1000000000).toFixed(1)} млрд руб.`;
        } else if (amount >= 1000000) {
          return `${(amount / 1000000).toFixed(1)} млн руб.`;
        } else if (amount >= 1000) {
          return `${(amount / 1000).toFixed(1)} тыс руб.`;
        } else {
          return `${amount.toFixed(0)} руб.`;
        }
      }

      function formatGrowth(growthText, hasValue = false) {
        if (!growthText) return "";

        const isPositive = growthText.includes("↑") || growthText.includes("+");
        const isNegative = growthText.includes("↓") || growthText.includes("-");

        let className = "";
        if (isPositive) className = "growth-positive";
        if (isNegative) className = "growth-negative";

        if (hasValue) {
          return `<span class="${className}">(${growthText})</span>`;
        } else {
          return `<span class="${className}">${growthText}</span>`;
        }
      }

      function displayResults(data) {
        if (!data.isDetailed) {
          document.getElementById("company-content").innerHTML = `
                    <div class="company-header">
                        <div class="company-name">${data.name}</div>
                        <div class="company-director">${data.director}</div>
                    </div>
                `;
          document.getElementById("results").style.display = "block";
          return;
        }

        const calculations = calculateFinancialMetrics(data);

        let contentHtml = `
                <div class="company-header">
                    <div class="company-name">${data.name}</div>
                    <div class="company-director">Генеральный директор: ${data.director}</div>
                </div>
            `;

        // Рентабельность - выделяем отдельно
        if (calculations.profitability) {
          contentHtml += `
                    <div class="profitability-highlight">
                        <div class="profitability-value">${calculations.profitability.toFixed(
                          2
                        )}%</div>
                        <div class="profitability-label">Рентабельность бизнеса</div>
                    </div>
                `;
        }

        // Основные метрики
        contentHtml += `<div class="metrics-grid">`;

        // Выручка
        if (data.revenue !== "Не найдено") {
          contentHtml += `
                    <div class="metric-card financial">
                        <div class="metric-label">📈 Выручка 2024</div>
                        <div class="metric-value">${data.revenue} ${
            data.revenueGrowth ? formatGrowth(data.revenueGrowth, true) : ""
          }</div>
                    </div>
                `;
        }

        // Чистая прибыль
        if (calculations.netProfit2024) {
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">💰 Чистая прибыль 2024</div>
                        <div class="metric-value">${formatAmount(
                          calculations.netProfit2024
                        )}</div>
                        <div class="metric-note">Расчёт по новой модели</div>
                    </div>
                `;
        }

        // ФОТ + Взносы
        if (calculations.fotWithContributions2024) {
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">👥 ФОТ + Взносы 2024</div>
                        <div class="metric-value">${formatAmount(
                          calculations.fotWithContributions2024
                        )}</div>
                        <div class="metric-note">Точный расчёт из взносов</div>
                    </div>
                `;
        }

        // Расходы на субподряд
        if (calculations.subcontractCosts2024) {
          const subcontractPercent = document.getElementById(
            "subcontract-percent"
          ).value;
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">🔨 Субподрядные работы</div>
                        <div class="metric-value">${formatAmount(
                          calculations.subcontractCosts2024
                        )}</div>
                        <div class="metric-note">${subcontractPercent}% от выручки</div>
                    </div>
                `;
        }

        // Операционные расходы
        if (calculations.operationalCosts2024) {
          const operationalPercent = document.getElementById(
            "operational-percent"
          ).value;
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">⚙️ Операционные расходы</div>
                        <div class="metric-value">${formatAmount(
                          calculations.operationalCosts2024
                        )}</div>
                        <div class="metric-note">${operationalPercent}% от выручки</div>
                    </div>
                `;
        }

        // Прибыль до налогов
        if (calculations.profitBeforeTax2024) {
          contentHtml += `
                    <div class="metric-card calculated">
                        <div class="metric-label">📊 Прибыль до налогов</div>
                        <div class="metric-value">${formatAmount(
                          calculations.profitBeforeTax2024
                        )}</div>
                        <div class="metric-note">До уплаты 20% налога</div>
                    </div>
                `;
        }

        contentHtml += `</div>`;

        // Исходные данные
        contentHtml += `
                <div class="section">
                    <div class="section-title">📋 Исходные данные</div>
                    <div class="metrics-grid">
            `;

        if (data.taxes) {
          contentHtml += `
                    <div class="metric-card">
                        <div class="metric-label">🏛️ Взносы (${data.taxes.year})</div>
                        <div class="metric-value">${data.taxes.fees}</div>
                        <div class="metric-note">Основа для расчета ФОТ</div>
                    </div>
                `;
        }

        if (data.profitGrowth) {
          contentHtml += `
                    <div class="metric-card">
                        <div class="metric-label">📈 Рост прибыли</div>
                        <div class="metric-value">${formatGrowth(
                          data.profitGrowth,
                          false
                        )}</div>
                        <div class="metric-note">Динамика развития</div>
                    </div>
                `;
        }

        if (data.valueGrowth) {
          contentHtml += `
                    <div class="metric-card">
                        <div class="metric-label">🏢 Рост стоимости</div>
                        <div class="metric-value">${formatGrowth(
                          data.valueGrowth,
                          false
                        )}</div>
                        <div class="metric-note">Динамика оценки</div>
                    </div>
                `;
        }

        contentHtml += `</div></div>`;

        // Дополнительная информация
        contentHtml += `
                <div class="section">
                    <div class="section-title">📋 Реквизиты компании</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">ИНН</div>
                            <div class="info-value">${data.inn}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ОГРН</div>
                            <div class="info-value">${data.ogrn}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Дата регистрации</div>
                            <div class="info-value">${data.registrationDate}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Уставный капитал</div>
                            <div class="info-value">${data.capital}</div>
                        </div>
                        <div class="info-item" style="grid-column: 1/-1;">
                            <div class="info-label">Юридический адрес</div>
                            <div class="info-value">${data.address}</div>
                        </div>
                    </div>
                </div>
            `;

        // Госзакупки
        if (data.procurement && data.procurement.customers.length > 0) {
          contentHtml += `
                    <div class="section">
                        <div class="section-title">🏛️ Государственные закупки</div>
                        <div class="procurement-section">
                            <p style="margin-bottom: 15px;"><strong>В роли:</strong> ${data.procurement.role}</p>
                            <p style="margin-bottom: 15px;"><strong>Топ-${data.procurement.customers.length} заказчиков:</strong></p>
                `;

          data.procurement.customers.forEach((customer, index) => {
            contentHtml += `
                        <div class="customer-item">
                            <div class="customer-name">${index + 1}. ${
              customer.name
            }</div>
                            <div class="customer-stats">${
                              customer.contracts
                            } на ${customer.amount}</div>
                        </div>
                    `;
          });

          if (data.procurement.totalContracts > 0) {
            contentHtml += `
                        <div style="background: var(--bg-secondary); padding: 15px; border-radius: 12px; margin-top: 15px; text-align: center; font-weight: 600;">
                            📊 Всего участвовала в ${data.procurement.totalContracts} закупках на сумму ${data.procurement.totalAmount}
                        </div>
                    `;
          }

          contentHtml += `</div></div>`;
        }

        // Краткая справка
        if (data.summary) {
          contentHtml += `
                    <div class="section">
                        <div class="section-title">📄 Справочная информация</div>
                        <div class="summary-section">
                            ${data.summary
                              .split("\n\n")
                              .map((paragraph) => `<p>${paragraph}</p>`)
                              .join("")}
                        </div>
                    </div>
                `;
        }

        // AI-сводка в самом конце (только если есть)
        if (data.aiSummary) {
          contentHtml += `
                    <div class="ai-summary-section">
                        <div class="section-title">🤖 AI-анализ компании</div>
                        <div class="ai-summary-content">
                            ${data.aiSummary
                              .split("\n\n")
                              .map((paragraph) => `<p>${paragraph}</p>`)
                              .join("")}
                        </div>
                    </div>
                `;
        }

        document.getElementById("company-content").innerHTML = contentHtml;
        document.getElementById("results").style.display = "block";
      }

      function showLoading(show) {
        const loading = document.getElementById("loading");
        const button = document.getElementById("searchButton");

        loading.style.display = show ? "block" : "none";
        button.disabled = show;

        if (show) {
          button.innerHTML = "⏳ Анализируем...";
        } else {
          button.innerHTML = "🔍 Анализировать компанию";
        }
      }

      function showError(message) {
        const error = document.getElementById("error-message");
        error.textContent = message;
        error.style.display = "block";
        error.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function hideError() {
        document.getElementById("error-message").style.display = "none";
      }

      // Пересчет при изменении параметров
      document
        .getElementById("subcontract-percent")
        .addEventListener("input", function () {
          if (
            currentCompanyData &&
            document.getElementById("results").style.display !== "none"
          ) {
            displayResults(currentCompanyData);
          }
        });

      document
        .getElementById("operational-percent")
        .addEventListener("input", function () {
          if (
            currentCompanyData &&
            document.getElementById("results").style.display !== "none"
          ) {
            displayResults(currentCompanyData);
          }
        });

      // Автоматическое форматирование ИНН
      document.getElementById("inn").addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 12) {
          value = value.slice(0, 12);
        }
        e.target.value = value;

        if (value.length > 0) {
          hideError();
        }
      });

      // Enter для поиска
      document.getElementById("inn").addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          searchCompany();
        }
      });

      // Фокус на поле при загрузке
      window.addEventListener("load", function () {
        document.getElementById("inn").focus();
      });
    </script>
  </body>
</html>
